<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS - Project</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* --- DARK THEME PALETTE --- */
            --bg-gradient: linear-gradient(135deg, #0f172a, #1e293b);
            --panel-bg: rgba(30, 41, 59, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            
            --accent: #fbbf24; 
            
            --danger: #ef4444; 
            --success: #22c55e;
        }

        body {
            margin: 0; font-family: 'Inter', sans-serif;
            background: var(--bg-gradient); 
            background-attachment: fixed;
            color: var(--text-main);
            min-height: 100vh; padding: 20px;
            box-sizing: border-box; 
            transition: all 0.3s ease;
        }

        /* --- SỬA SCROLLBAR ĐỒNG BỘ MÀU TỐI --- */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* --- 1. ADMIN MODE & UI COMPONENTS --- */
        body.admin-mode::after {
            content: "";
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 99999; 
            pointer-events: none; 
            box-shadow: inset 0 0 0 4px var(--danger), inset 0 0 30px rgba(239, 68, 68, 0.4);
            animation: pulseRedSoft 2s infinite alternate;
        }

        @keyframes pulseRedSoft {
            from { box-shadow: inset 0 0 0 4px var(--danger), inset 0 0 15px rgba(239, 68, 68, 0.1); }
            to { box-shadow: inset 0 0 0 4px var(--danger), inset 0 0 40px rgba(239, 68, 68, 0.5); }
        }

        #admin-badge {
            display: none; position: fixed; top: 0; left: 50%; transform: translateX(-50%);
            background: var(--danger); color: white; padding: 5px 25px;
            font-weight: 800; font-size: 0.8em; letter-spacing: 1px; text-transform: uppercase;
            z-index: 20001; border-radius: 0 0 12px 12px; box-shadow: 0 5px 15px rgba(239, 68, 68, 0.5);
        }
        body.admin-mode #admin-badge { display: block; }

        #admin-toast {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(15px);
            border: 1px solid var(--accent); color: var(--accent);
            padding: 15px 40px; border-radius: 50px; display: flex; align-items: center; gap: 15px; z-index: 20000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: top 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        #admin-toast.show { top: 80px; }
        #admin-toast span { font-weight: bold; font-size: 1.1em; color: white; }
        
        .admin-toggle { 
            position: fixed; top: 20px; right: 20px; 
            background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(5px); color: var(--text-main);
            border: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; z-index: 9999; 
            padding: 10px 20px; border-radius: 30px; display: flex; align-items: center; gap: 10px;
            transition: all 0.2s ease; font-weight: 600; font-size: 0.85em;
        }
        .admin-toggle:hover { 
            background: var(--accent); border-color: var(--accent); color: #000;
            transform: translateY(-2px); box-shadow: 0 0 15px rgba(251, 191, 36, 0.4);
        }

        /* --- LAYOUT --- */
        .container { max-width: 900px; margin: 0 auto; margin-top: 60px; padding-bottom: 50px; }
        .screen { display: none; animation: fadeIn 0.4s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .glass-panel {
            background: var(--panel-bg); backdrop-filter: blur(16px);
            border: var(--glass-border); border-radius: 20px;
            padding: 40px; margin-bottom: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }

        h1, h2, h3, h4 { color: var(--text-main); margin-top: 0; font-weight: 800; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-top: 20px; }
        .card {
            background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s; text-align: center;
        }
        .card:hover { transform: translateY(-5px); background: rgba(255,255,255,0.1); border-color: var(--accent); }
        .card i { font-size: 2em; margin-bottom: 10px; color: var(--accent); }
        
        /* --- FORMS --- */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--accent); font-size: 0.9em; }
        input[type="text"], textarea, select {
            width: 100%; padding: 12px; border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1); background: rgba(0, 0, 0, 0.4) !important; 
            color: white !important; box-sizing: border-box; font-family: inherit; transition: 0.2s;
        }
        input:focus, textarea:focus, select:focus { border-color: var(--accent); outline: none; background: rgba(0,0,0,0.6) !important; }
        select option { background-color: #1e293b; color: white; }

        .opt-row { padding: 10px 0; border-bottom: 1px dashed rgba(255,255,255,0.1); display: flex; align-items: center; gap: 15px; }
        .opt-row input[type="text"] { background: transparent !important; border: none !important; border-bottom: 1px solid rgba(255,255,255,0.3) !important; border-radius: 0 !important; }
        .opt-row input[type="text"]:focus { border-bottom: 2px solid var(--accent) !important; }

        /* --- BUTTONS & ERROR FEEDBACK --- */
        .btn-primary { background: var(--accent); color: #000; border: none; padding: 12px 30px; font-weight: 700; border-radius: 30px; cursor: pointer; transition: 0.2s; }
        .btn-primary:hover { background: #fff; transform: translateY(-2px); box-shadow: 0 0 15px var(--accent); }
        .btn-danger { background: transparent; color: var(--danger); border: 1px solid var(--danger); padding: 10px 25px; font-weight: 600; border-radius: 30px; cursor: pointer; transition: 0.2s; }
        .btn-danger:hover { background: var(--danger); color: white; }
        .btn-add { width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px dashed rgba(255,255,255,0.3); color: #ccc; cursor: pointer; border-radius: 8px; margin-top: 10px; font-weight: 600; transition: 0.2s; }
        .btn-add:hover { background: rgba(255,255,255,0.1); color: var(--accent); border-color: var(--accent); }
        .btn-icon { background: none; border: none; color: rgba(255,255,255,0.4); cursor: pointer; font-size: 1.2em; transition: 0.2s; }
        .btn-icon:hover { color: var(--danger); transform: scale(1.2); }

        /* [MỚI] Hiệu ứng nháy đỏ khi lỗi */
        @keyframes flashRedBtn {
            0% { border-color: var(--accent); color: #000; background: var(--accent); }
            50% { border-color: var(--danger); color: var(--danger); background: transparent; transform: scale(1.05); box-shadow: 0 0 15px var(--danger); }
            100% { border-color: var(--accent); color: #000; background: var(--accent); }
        }
        .btn-error-flash { animation: flashRedBtn 0.5s ease-in-out; }
        
        #save-error-msg {
            color: var(--danger); font-size: 0.9em; margin-top: 10px; font-weight: 700; text-align: right; min-height: 1.2em; display: block;
        }

        /* --- QUIZ UI --- */
        .ans-btn {
            display: flex; align-items: center; 
            justify-content: flex-start; /* Căn trái */
            text-align: left;            /* Căn trái */
            gap: 15px;
            width: 96%; margin: 0 auto 12px auto; /* Thu gọn */
            padding: 18px; 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-main); border-radius: 12px; cursor: pointer; transition: 0.2s; font-weight: 500;
        }
        .ans-btn:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); }
        .ans-btn.selected { background: rgba(251, 191, 36, 0.2); border-color: var(--accent); color: var(--accent); font-weight: 700; }
        .ans-btn.correct-show { background: rgba(34, 197, 94, 0.2); border-color: var(--success); color: var(--success); }
        .ans-btn.wrong-show { background: rgba(239, 68, 68, 0.2); border-color: var(--danger); color: var(--danger); }
        
        /* Animation khi trộn câu hỏi */
        @keyframes shuffleEffect {
            0% { transform: scale(1); opacity: 1; filter: blur(0); }
            50% { transform: scale(0.98); opacity: 0.5; filter: blur(4px); }
            100% { transform: scale(1); opacity: 1; filter: blur(0); }
        }
        .shuffling { animation: shuffleEffect 0.6s ease-in-out; pointer-events: none; }

        /* Specific Review Styles */
        .review-q-block { margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; }
        .review-q-block h3 { color: var(--accent); margin-bottom: 15px; font-size: 1.1em; }
        
        .review-ans { 
            padding: 12px; margin-bottom: 8px; border-radius: 8px; 
            font-size: 0.95em; color: var(--text-muted); 
            background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05);
            display: flex; align-items: center; gap: 10px;
        }
        
        .review-ans.correct { color: var(--success); border: 1px solid var(--success); background: rgba(34, 197, 94, 0.1); font-weight: 700; }

        /* IMAGES STYLE */
        .ans-btn img, .review-ans img {
            max-width: 80px; height: auto; 
            border-radius: 5px; border: 1px solid rgba(255,255,255,0.2);
            object-fit: contain; margin-right: 10px; order: -1;
            cursor: zoom-in; transition: transform 0.2s; vertical-align: middle;
        }
        .ans-btn img:hover, .review-ans img:hover { transform: scale(1.05); border-color: var(--accent); }

        #display-q-img {
            max-width: 33.33% !important; height: auto; border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2); display: none; margin: 10px 0;
            cursor: zoom-in; transition: transform 0.2s;
        }
        #display-q-img:hover { transform: scale(1.02); border-color: var(--accent); }
        
        /* Drag UI */
        .drag-area { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin: 20px 0; }
        .draggable { background: #1e293b; border: 1px solid var(--accent); color: var(--accent); padding: 10px 20px; border-radius: 8px; cursor: grab; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .drop-zone { border: 2px dashed rgba(255,255,255,0.2); min-width: 130px; min-height: 90px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; }
        .drop-zone.hover { border-color: var(--accent); background: rgba(251, 191, 36, 0.1); }
        .drop-zone.error { border-color: var(--danger); background: rgba(239, 68, 68, 0.1); } 
        .drop-zone.success { border-color: var(--success); background: rgba(34, 197, 94, 0.1); }
        
        /* Fill In Blank UI */
        .fill-input {
            width: 100%; padding: 15px; font-size: 1.1em;
            background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.2);
            color: white; border-radius: 10px; margin-bottom: 20px; text-align: center;
        }
        .fill-input:focus { border-color: var(--accent); outline: none; }
        .fill-input.correct { border-color: var(--success); background: rgba(34, 197, 94, 0.1); color: var(--success); }
        .fill-input.wrong { border-color: var(--danger); background: rgba(239, 68, 68, 0.1); color: var(--danger); }

        /* LIST & SMALL BUTTONS */
        #questions-list { margin-top: 15px; max-height: 350px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.05); border-radius: 8px; padding: 5px; }
        
        .q-item { 
            background: rgba(0,0,0,0.2); padding: 12px; margin-bottom: 8px; 
            border-radius: 8px; display: flex; justify-content: space-between; align-items: center; 
            border: 1px solid transparent; transition: 0.2s; 
        }
        .q-item:hover { border-color: var(--accent); background: rgba(255,255,255,0.03); }
        
        .q-item-content { flex: 1; display: flex; align-items: center; overflow: hidden; padding-right: 10px; }
        .q-item-content span:last-child { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .btn-group { display: flex; gap: 5px; flex-shrink: 0; }

        .btn-sm { 
            padding: 6px 12px; font-size: 0.85em; 
            border: 1px solid rgba(255,255,255,0.2); 
            margin-left: 5px; color: #ccc; border-radius: 6px; 
            background: transparent !important; cursor: pointer; transition: 0.2s;
        }
        .btn-sm:hover { 
            border-color: var(--accent); color: var(--accent); 
            background: rgba(251, 191, 36, 0.05) !important;
        }
        
        .badge { 
            font-size: 0.7em; padding: 3px 8px; border-radius: 4px; margin-right: 10px; 
            font-weight: 700; background: rgba(255,255,255,0.1); color: var(--accent); 
            border: 1px solid var(--accent); 
        }
        
        .preview-img { max-height: 40px; border-radius: 4px; border: 1px solid #555; margin-left: 10px;}
        .hide { display: none !important; }
        .shake { animation: shakeAnim 0.4s; }
        @keyframes shakeAnim { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
        #loading { text-align: center; padding: 20px; color: var(--accent); font-style: italic; display: none; }

        /* --- 5. IMAGE VIEWER MODAL --- */
        #image-viewer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(8px);
            z-index: 50000; display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease; overflow: hidden;
        }
        #image-viewer.active { opacity: 1; pointer-events: all; }
        #viewer-container { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; cursor: grab; }
        #viewer-container:active { cursor: grabbing; }
        #full-image { max-width: 90vw; max-height: 90vh; object-fit: contain; transition: transform 0.1s linear; user-select: none; border-radius: 4px; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .viewer-hint { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); color: white; background: rgba(0,0,0,0.5); padding: 8px 16px; border-radius: 20px; font-size: 0.85em; pointer-events: none; border: 1px solid rgba(255,255,255,0.2); }
        .close-viewer { position: absolute; top: 20px; right: 20px; color: white; font-size: 2em; cursor: pointer; background: none; border: none; padding: 10px; z-index: 50001; transition: 0.2s; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .close-viewer:hover { color: var(--accent); transform: scale(1.1); }

        /* --- 6. SUCCESS MODAL --- */
        #success-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 60000; display: none; align-items: center; justify-content: center; }
        #success-modal.active { display: flex; animation: fadeIn 0.3s ease; }
        .modal-content { background: #1e293b; padding: 30px; border-radius: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-width: 350px; width: 90%; }
    </style>
</head>
<body>

    <div id="image-viewer">
        <button class="close-viewer" onclick="closeImageViewer()"><i class="fas fa-times"></i></button>
        <div id="viewer-container" onmousedown="startDrag(event)">
            <img id="full-image" src="">
        </div>
        <div class="viewer-hint"><i class="fas fa-mouse"></i> Lăn chuột để Zoom • Kéo để di chuyển</div>
    </div>

    <div id="success-modal">
        <div class="modal-content">
            <h3 style="color: var(--success); margin-bottom: 10px; font-size: 1.5em;">Hoàn thành!</h3>
            <p style="color: var(--text-muted); margin-bottom: 25px;">Bạn đã trả lời hết các câu hỏi.</p>
            <button class="btn-primary" onclick="closeSuccessModal()">Xem kết quả</button>
        </div>
    </div>

    <div id="admin-badge">Endmin Mode</div>
    <div id="admin-toast">
        <i class="fas fa-check-circle" style="color: var(--success);"></i>
        <span>Welcome back, Endministrator</span>
    </div>

    <button class="admin-toggle" onclick="toggleAdmin()">
        <i class="fas fa-user-shield"></i>
        <span>Endministrator</span>
    </button>

    <div class="container">
        <section id="home-screen" class="screen active">
            <div class="glass-panel" style="text-align: center;">
                <h1 style="color: var(--accent); font-size: 2em; margin-bottom: 10px;">HỆ THỐNG TRẮC NGHIỆM</h1>
                <p style="color: var(--text-muted); margin-bottom: 30px;">Chọn môn học để bắt đầu ôn tập</p>
                <div class="grid" id="subjects-grid"></div>
            </div>
        </section>

        <section id="lesson-screen" class="screen">
            <div class="glass-panel">
                <button onclick="goHome()" style="background:none; border:none; color:var(--text-muted); cursor:pointer; margin-bottom:20px; font-weight: 600;">
                    <i class="fas fa-arrow-left"></i> Quay lại trang chủ
                </button>
                <h2 id="current-subject-title" style="color: var(--accent);">Tên Môn</h2>
                <p id="admin-hint" class="hide" style="color:var(--danger); font-weight:600; background: rgba(239, 68, 68, 0.1); display: inline-block; padding: 5px 15px; border-radius: 20px; border: 1px solid var(--danger);">[Đang ở chế độ chỉnh sửa]</p>
                <div class="grid" id="lessons-grid"></div>
            </div>
        </section>

        <section id="quiz-screen" class="screen">
            <div class="glass-panel" id="quiz-card">
                <div style="display:flex; justify-content:space-between; align-items:center; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <span id="progress" style="font-weight: 700; color: var(--accent);">Câu 1</span>
                    
                    <div style="display:flex; align-items:center; gap: 15px;">
                        <button onclick="shuffleAndRestart()" class="btn-sm" style="color: var(--accent); border-color: var(--accent); display:flex; gap:5px; align-items:center;">
                            <i class="fas fa-random"></i> <span>Trộn câu hỏi</span>
                        </button>
                        
                        <span onclick="goBackToLessons()" style="cursor:pointer; color: var(--text-muted); font-size: 0.9em;">Thoát bài tập</span>
                    </div>
                </div>

                <div id="loading">Đang tải dữ liệu...</div>
                
                <div id="quiz-content">
                    <h3 id="display-q-text" style="margin: 20px 0; font-weight: 600; font-size: 1.3em;"></h3>
                    <div style="text-align:left; margin-bottom:20px;">
                        <img id="display-q-img" src="" onclick="viewImage(this.src)" alt="Question Image">
                    </div>
                    <div id="quiz-options-area"></div>
                    <div style="margin-top: 30px; text-align: right;">
                        <button id="check-btn" class="btn-primary hide" onclick="checkAnswer()">Kiểm tra đáp án</button>
                        <button id="next-btn" class="btn-primary hide" onclick="nextQuestion()">Câu tiếp theo <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>

                <div id="review-content" class="hide">
                    <h2 style="color: var(--success); text-align: center; margin-bottom: 30px;">Xem lại đáp án</h2>
                    <div id="review-list"></div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn-primary" onclick="goBackToLessons()">Hoàn thành & Thoát</button>
                    </div>
                </div>

            </div>
        </section>

        <section id="admin-editor-screen" class="screen">
            <div class="glass-panel">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px;">
                    <h3 id="editor-title" style="margin:0; color: var(--accent);">Trình chỉnh sửa</h3>
                    <button onclick="goBackToLessons()" class="btn-danger">Đóng</button>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 25px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.05);">
                    <h4 id="form-header" style="margin-top:0; color:var(--text-main);">Thêm câu hỏi mới</h4>
                    <div class="form-group">
                        <label>Loại câu hỏi</label>
                        <select id="q-type" onchange="renderOptionsForm()">
                            <option value="single">Chọn 1 đáp án (Single)</option>
                            <option value="multi">Chọn nhiều đáp án (Multi)</option>
                            <option value="drag">Kéo thả (Drag & Drop)</option>
                            <option value="fill">Điền từ (Fill in blank)</option>
                        </select>
                        <p id="drag-hint" style="color:var(--accent); font-size:0.85em; margin-top:5px; font-style:italic; display:none;">*Chú ý: Đặt tên "Ô đáp án" giống nhau để kéo nhiều đáp án vào chung 1 ô.</p>
                    </div>
                    <div class="form-group">
                        <label>Nội dung câu hỏi</label>
                        <textarea id="q-text" rows="2" placeholder="Ví dụ: Thủ đô của Việt Nam là ..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Hình ảnh (Tùy chọn)</label>
                        <div style="display:flex; align-items:center;">
                            <input type="text" id="q-img" placeholder="Dán link ảnh vào đây..." oninput="previewImage(this, 'editor-prev')">
                            <img id="editor-prev" class="preview-img" src="" style="display:none;">
                        </div>
                    </div>
                    <div id="options-container" style="margin-top:20px;"></div>
                    <button id="add-opt-btn" class="btn-add" onclick="addNewOptionRow()">+ Thêm dòng đáp án</button>
                    
                    <div style="margin-top:30px; text-align:right;">
                        <div style="display: flex; justify-content: flex-end; gap: 10px;">
                            <button class="btn-danger" style="border:1px solid rgba(255,255,255,0.2); color: #ccc;" onclick="resetForm()">Làm mới</button>
                            <button id="btn-save-q" class="btn-primary" onclick="saveQuestion()">Lưu câu hỏi</button>
                        </div>
                        <div id="save-error-msg"></div>
                    </div>

                </div>
                <h4 style="margin-top: 40px; color: var(--text-muted); display:flex; justify-content:flex-start; align-items:center;">Danh sách câu hỏi (<span id="list-count">0</span>)</h4>
                <div id="questions-list"></div>
                <div style="margin-top:30px; text-align:center;">
                    <button class="btn-primary" style="background: transparent; border: 1px solid var(--success); color: var(--success);" onclick="exportJSON()"><i class="fas fa-download"></i> Tải file dữ liệu (.JSON) về máy</button>
                </div>
            </div>
        </section>
    </div>

<script>
    const subjects = [
        { id: 'kinhte', name: 'Kinh tế chính trị Mác - Lê Nin', icon: 'fa-book', lessons: 6 },
        { id: 'laptrinhC', name: 'Lập trình C Nâng cao', icon: 'fa-code', lessons: 9 },
        { id: 'thongtinso', name: 'Thông tin Số', icon: 'fa-network-wired', lessons: 9 },
        { id: 'truyensolieu', name: 'Kỹ thuật truyền số liệu', icon: 'fa-satellite-dish', lessons: 9 },
        { id: 'maydien', name: 'Máy điện', icon: 'fa-bolt', lessons: 9 }
    ];

    let currentSubjectId = null;
    let currentLessonId = null;
    let isAdminMode = false;
    let currentQuizData = [];
    let editingIndex = -1;

    // --- ZOOM IMAGE VARIABLES ---
    let imgScale = 1; let imgTranslateX = 0; let imgTranslateY = 0;
    let isDraggingImg = false; let startDragX, startDragY;

    function init() {
        const grid = document.getElementById('subjects-grid');
        grid.innerHTML = "";
        subjects.forEach(sub => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<i class="fas ${sub.icon}"></i><h3>${sub.name}</h3>`;
            card.onclick = () => openLessons(sub);
            grid.appendChild(card);
        });
        document.getElementById('image-viewer').addEventListener('wheel', handleZoom, { passive: false });
        window.addEventListener('mousemove', dragImage);
        window.addEventListener('mouseup', stopDragImage);
    }
    init();

    // --- IMAGE VIEWER LOGIC ---
    function viewImage(src) {
        if(window.event) window.event.stopPropagation();
        const viewer = document.getElementById('image-viewer');
        const img = document.getElementById('full-image');
        img.src = src;
        imgScale = 1; imgTranslateX = 0; imgTranslateY = 0;
        updateImageTransform();
        viewer.classList.add('active');
    }
    function closeImageViewer() { document.getElementById('image-viewer').classList.remove('active'); }
    function handleZoom(e) {
        e.preventDefault(); const zoomStep = 0.1;
        if (e.deltaY < 0) imgScale += zoomStep; else imgScale -= zoomStep;
        imgScale = Math.min(Math.max(0.5, imgScale), 5);
        updateImageTransform();
    }
    function startDrag(e) {
        if(e.target.id !== 'full-image' && e.target.id !== 'viewer-container') return;
        isDraggingImg = true; startDragX = e.clientX - imgTranslateX; startDragY = e.clientY - imgTranslateY;
        document.getElementById('viewer-container').style.cursor = 'grabbing';
    }
    function dragImage(e) {
        if (!isDraggingImg) return; e.preventDefault();
        imgTranslateX = e.clientX - startDragX; imgTranslateY = e.clientY - startDragY;
        updateImageTransform();
    }
    function stopDragImage() { isDraggingImg = false; document.getElementById('viewer-container').style.cursor = 'grab'; }
    function updateImageTransform() { document.getElementById('full-image').style.transform = `translate(${imgTranslateX}px, ${imgTranslateY}px) scale(${imgScale})`; }

    // --- SUCCESS MODAL LOGIC ---
    function showSuccessModal() {
        const modal = document.getElementById('success-modal');
        modal.classList.add('active');
    }
    function closeSuccessModal() {
        document.getElementById('success-modal').classList.remove('active');
        showReviewScreen();
    }

    // --- REVIEW SCREEN LOGIC ---
    function showReviewScreen() {
        document.getElementById('quiz-content').classList.add('hide');
        document.getElementById('review-content').classList.remove('hide');
        document.getElementById('progress').innerText = "Xem lại kết quả";
        
        const list = document.getElementById('review-list');
        list.innerHTML = "";

        currentQuizData.forEach((q, i) => {
            const block = document.createElement('div');
            block.className = 'review-q-block';
            let html = `<h3>Câu ${i+1}: ${q.text}</h3>`;
            if(q.img) html += `<div style="margin-bottom:10px;"><img src="${q.img}" style="max-height:100px; border-radius:5px;" onclick="viewImage(this.src)"></div>`;
            
            if(q.type === 'drag') {
                html += `<div style="color:var(--text-muted); font-style:italic;">(Câu hỏi kéo thả - Đáp án đúng:)</div>`;
                q.pairs.forEach(p => {
                    html += `<div class="review-ans correct">${p.label} <i class="fas fa-arrow-right"></i> ${p.target}</div>`;
                });
            } else if (q.type === 'fill') {
                html += `<div style="color:var(--text-muted); margin-bottom:5px;">Các đáp án được chấp nhận:</div>`;
                const answers = q.fillAnswers || [q.fillAnswer];
                html += `<div class="review-ans correct">${answers.join(' / ')}</div>`;
            } else {
                q.answers.forEach(a => {
                    const isCorrect = a.correct ? 'correct' : '';
                    const icon = a.correct ? '<i class="fas fa-check" style="margin-left:auto;"></i>' : '';
                    html += `<div class="review-ans ${isCorrect}">
                        ${a.img ? `<img src="${a.img}" onclick="viewImage(this.src)">` : ''}
                        <span>${a.text || '(Hình ảnh)'}</span>
                        ${icon}
                    </div>`;
                });
            }
            block.innerHTML = html;
            list.appendChild(block);
        });
    }

    // --- NORMAL APP LOGIC ---
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
    function goHome() { currentSubjectId = null; showScreen('home-screen'); }
    function goBackToLessons() {
        if(currentSubjectId) openLessons(subjects.find(s => s.id === currentSubjectId));
        else goHome();
    }
    function toggleAdmin() {
        if(isAdminMode) {
            isAdminMode = false; document.body.classList.remove('admin-mode');
            showToast("Endmin log out", false); goHome();
        } else {
            if(prompt("Nhập mật khẩu :") === "2006") {
                isAdminMode = true; document.body.classList.add('admin-mode');
                showToast("Welcome back, Endministrator"); goHome(); 
            } else alert("Sai mật khẩu");
        }
    }
    function showToast(msg) {
        const toast = document.getElementById('admin-toast');
        toast.querySelector('span').innerText = msg;
        toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 1000);
    }
    function openLessons(subject) {
        currentSubjectId = subject.id;
        document.getElementById('current-subject-title').innerText = subject.name;
        document.getElementById('admin-hint').classList.toggle('hide', !isAdminMode);
        const grid = document.getElementById('lessons-grid'); grid.innerHTML = "";
        for(let i=1; i<=subject.lessons; i++) {
            const card = document.createElement('div');
            card.className = 'card'; card.innerHTML = `<h3 style="margin-top:5px;">Bài ${i}</h3>`;
            card.onclick = () => { currentLessonId = i; smartLoadData(currentSubjectId, i); };
            grid.appendChild(card);
        }
        showScreen('lesson-screen');
    }
    async function smartLoadData(subId, lesId) {
        currentQuizData = []; 
        if (isAdminMode) {
            const localKey = `quiz_${subId}_${lesId}`; const raw = localStorage.getItem(localKey);
            currentQuizData = raw ? JSON.parse(raw) : []; openAdminEditor();
        } else {
            const jsonPath = `data/${subId}/bai${lesId}.json`;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('quiz-content').style.display = 'none';
            document.getElementById('review-content').classList.add('hide'); 
            showScreen('quiz-screen');
            try {
                const response = await fetch(jsonPath); if (!response.ok) throw new Error("File not found");
                currentQuizData = await response.json(); startQuiz();
            } catch (error) {
                console.log("Tìm LocalStorage...");
                const localKey = `quiz_${subId}_${lesId}`; const raw = localStorage.getItem(localKey);
                if(raw) { currentQuizData = JSON.parse(raw); startQuiz(); }
                else { alert("Bài học này chưa có dữ liệu!"); goBackToLessons(); }
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
    }
    function saveQuizData() { localStorage.setItem(`quiz_${currentSubjectId}_${currentLessonId}`, JSON.stringify(currentQuizData)); }
    function openAdminEditor() {
        showScreen('admin-editor-screen');
        document.getElementById('editor-title').innerText = `Chỉnh sửa: ${currentSubjectId} / Bài ${currentLessonId}`;
        resetForm(); renderQuestionList();
    }
    function resetForm() {
        editingIndex = -1; document.getElementById('form-header').innerText = "Thêm câu hỏi mới";
        document.getElementById('q-text').value = ""; document.getElementById('q-img').value = "";
        document.getElementById('editor-prev').style.display = 'none'; renderOptionsForm();
        document.getElementById('save-error-msg').innerText = ""; // Clear error
    }
    function previewImage(input, imgId) {
        const img = document.getElementById(imgId);
        if(input.value) { img.src = input.value; img.style.display = "block"; } else { img.style.display = "none"; }
    }
    
    // --- UPDATED RENDER FORM LOGIC ---
    function renderOptionsForm(presetType=null) {
        const type = presetType || document.getElementById('q-type').value;
        const container = document.getElementById('options-container');
        const hint = document.getElementById('drag-hint');
        const addBtn = document.getElementById('add-opt-btn');
        
        container.innerHTML = "";
        addBtn.style.display = 'block'; 

        if(type === 'fill') {
            hint.style.display = 'none';
            addBtn.onclick = () => addFillOptionRow(); 
            if(editingIndex === -1) addFillOptionRow();
        } else {
            addBtn.onclick = () => addNewOptionRow(); 
            if(type === 'drag') hint.style.display = 'block'; else hint.style.display = 'none';
            if(editingIndex === -1) { addNewOptionRow(); addNewOptionRow(); }
        }
    }

    // --- HELPER FOR FILL ROWS ---
    function addFillOptionRow(value = '') {
        const container = document.getElementById('options-container');
        const div = document.createElement('div');
        div.className = 'opt-row';
        div.innerHTML = `
            <label style="width: auto; margin:0; color:var(--success); white-space:nowrap; margin-right:10px;">Đáp án:</label>
            <input type="text" class="fill-option-text" value="${value}" placeholder="Nhập một đáp án chấp nhận..." style="flex:1">
            <button class="btn-icon" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
        `;
        container.appendChild(div);
    }

    function addNewOptionRow(data=null) {
        const type = document.getElementById('q-type').value;
        const container = document.getElementById('options-container');
        const div = document.createElement('div'); div.className = 'opt-row';
        if(type === 'drag') {
            const l = data?data.label:''; const t = data?data.target:'';
            div.innerHTML = `
                <input type="text" class="drag-source" value="${l}" placeholder="Đáp án (VD: R1)" style="flex:1">
                <i class="fas fa-arrow-right" style="color:var(--accent)"></i>
                <input type="text" class="drag-target" value="${t}" placeholder="Ô đáp án (VD: Nhóm A)" style="flex:1">
                <button class="btn-icon" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
            `;
        } else {
            const itype = type==='single'?'radio':'checkbox';
            const chk = data?(data.correct?'checked':''):'';
            const txt = data?data.text:''; const img = data?(data.img||''):'';
            div.innerHTML = `
                <input type="${itype}" name="cor" class="correct-chk" ${chk} style="transform:scale(1.5); cursor:pointer; accent-color: var(--accent);">
                <div style="flex:1; display:flex; gap:10px;">
                    <input type="text" class="opt-text" value="${txt}" placeholder="Nội dung đáp án...">
                    <input type="text" class="opt-img" value="${img}" placeholder="Link ảnh...">
                </div>
                <button class="btn-icon" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
            `;
        }
        container.appendChild(div);
    }

    // --- [MỚI] HÀM HIỂN THỊ LỖI ---
    function showSaveError(msg) {
        const errDiv = document.getElementById('save-error-msg');
        const btn = document.getElementById('btn-save-q');
        errDiv.innerText = msg;
        btn.classList.add('btn-error-flash');
        setTimeout(() => { btn.classList.remove('btn-error-flash'); }, 500);
    }

    // --- [CẬP NHẬT] HÀM LƯU CÂU HỎI KÈM VALIDATION ---
    function saveQuestion() {
        document.getElementById('save-error-msg').innerText = ""; // Reset lỗi cũ

        const type = document.getElementById('q-type').value;
        const text = document.getElementById('q-text').value.trim();
        const img = document.getElementById('q-img').value.trim();
        
        if(!text) return showSaveError("Vui lòng nhập nội dung câu hỏi!");
        
        let newQ = { type, text, img: img||null };
        
        // CHECK TỪNG LOẠI
        if (type === 'fill') {
            newQ.fillAnswers = [];
            const inputs = document.querySelectorAll('.fill-option-text');
            inputs.forEach(inp => {
                if(inp.value.trim()) newQ.fillAnswers.push(inp.value.trim());
            });
            // Rule: Ít nhất 1 từ
            if(newQ.fillAnswers.length === 0) return showSaveError("Cần ít nhất 1 đáp án điền từ!");

        } else if(type === 'drag') {
            const rows = document.querySelectorAll('.opt-row');
            newQ.pairs = [];
            rows.forEach(r => {
                const s = r.querySelector('.drag-source').value.trim(); 
                const t = r.querySelector('.drag-target').value.trim();
                if(s && t) newQ.pairs.push({ label:s, target:t });
            });
            // Rule: Ít nhất 1 cặp
            if(newQ.pairs.length < 1) return showSaveError("Cần ít nhất 1 cặp kéo thả!");

        } else {
            // Single hoặc Multi
            const rows = document.querySelectorAll('.opt-row');
            newQ.answers = [];
            let correctCount = 0;

            rows.forEach(r => {
                const txt = r.querySelector('.opt-text').value.trim(); 
                const i = r.querySelector('.opt-img').value.trim(); 
                const c = r.querySelector('.correct-chk').checked;
                
                if(txt || i) {
                    newQ.answers.push({ text:txt, img:i||null, correct:c });
                    if(c) correctCount++;
                }
            });

            if(newQ.answers.length === 0) return showSaveError("Vui lòng nhập ít nhất 1 dòng đáp án!");

            // Rule: Single cần >= 1 đúng
            if (type === 'single' && correctCount < 1) {
                return showSaveError("Chọn ít nhất 1 đáp án ĐÚNG!");
            }
            
            // Rule: Multi cần >= 2 đúng
            if (type === 'multi' && correctCount < 2) {
                return showSaveError("Câu nhiều lựa chọn cần ít nhất 2 đáp án ĐÚNG!");
            }
        }

        // Nếu hợp lệ thì lưu
        if(editingIndex > -1) currentQuizData[editingIndex] = newQ; 
        else currentQuizData.push(newQ);
        
        saveQuizData(); 
        resetForm(); 
        renderQuestionList();
        
        // Thông báo thành công nhẹ
        const errDiv = document.getElementById('save-error-msg');
        errDiv.style.color = 'var(--success)';
        errDiv.innerText = "Đã lưu thành công!";
        setTimeout(() => { 
            errDiv.innerText = ""; 
            errDiv.style.color = 'var(--danger)';
        }, 2000);
    }

    function renderQuestionList() {
        const list = document.getElementById('questions-list');
        document.getElementById('list-count').innerText = currentQuizData.length; list.innerHTML = "";
        currentQuizData.forEach((q, idx) => {
            const d = document.createElement('div'); d.className = 'q-item';
            d.innerHTML = `
                <div class="q-item-content"><span class="badge">${q.type}</span><span>${q.text}</span></div>
                <div class="btn-group"><button class="btn-sm" onclick="editQ(${idx})">Sửa</button><button class="btn-sm" style="color:var(--danger); border-color:rgba(239,68,68,0.3);" onclick="delQ(${idx})">Xóa</button></div>
            `;
            list.appendChild(d);
        });
    }
    function delQ(idx) { if(confirm("Xóa câu hỏi này?")) { currentQuizData.splice(idx,1); saveQuizData(); renderQuestionList(); } }
    
    function editQ(idx) {
        editingIndex = idx; const q = currentQuizData[idx];
        document.getElementById('form-header').innerText = `Đang sửa câu hỏi #${idx+1}`;
        document.getElementById('q-type').value = q.type; document.getElementById('q-text').value = q.text; document.getElementById('q-img').value = q.img||"";
        renderOptionsForm(q.type);
        const container = document.getElementById('options-container'); 
        
        if (q.type === 'fill') {
            container.innerHTML = "";
            const answers = q.fillAnswers || (q.fillAnswer ? [q.fillAnswer] : []);
            answers.forEach(ans => addFillOptionRow(ans));
        } else {
            container.innerHTML = "";
            if(q.type === 'drag') q.pairs.forEach(p => addNewOptionRow(p)); else q.answers.forEach(a => addNewOptionRow(a));
        }
    }
    
    function exportJSON() {
        if(currentQuizData.length === 0) return alert("Chưa có dữ liệu!");
        const dataStr = JSON.stringify(currentQuizData, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = `bai${currentLessonId}.json`;
        document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
    }

    let qIdx = 0;

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function shuffleAndRestart() {
        if(currentQuizData.length === 0) return;
        
        const content = document.getElementById('quiz-content');
        content.classList.add('shuffling');
        
        setTimeout(() => {
            shuffleArray(currentQuizData); 
            renderQuizQ(); 
        }, 300);

        setTimeout(() => {
            content.classList.remove('shuffling');
        }, 600);
    }

    function startQuiz() {
        if(currentQuizData.length === 0) return alert("Bài học này chưa có câu hỏi nào!");
        qIdx = 0; 
        document.getElementById('quiz-content').style.display = 'block'; 
        renderQuizQ();
    }

    function renderQuizQ() {
        const q = currentQuizData[qIdx];
        const area = document.getElementById('quiz-options-area');
        document.getElementById('progress').innerText = `Câu ${qIdx+1} / ${currentQuizData.length}`;
        document.getElementById('display-q-text').innerText = q.text;
        
        const mi = document.getElementById('display-q-img');
        if(q.img) { mi.src=q.img; mi.style.display='inline-block'; } else mi.style.display='none';
        
        document.getElementById('check-btn').classList.add('hide');
        document.getElementById('next-btn').classList.add('hide');
        document.getElementById('quiz-card').classList.remove('shake');
        area.innerHTML = "";

        if(q.type === 'drag') {
            document.getElementById('check-btn').classList.remove('hide');
            const dBox = document.createElement('div'); dBox.className='drag-area';
            const zBox = document.createElement('div'); zBox.className='drag-area';
            q.pairs.forEach((p,i) => {
                const item = document.createElement('div');
                item.className='draggable'; item.innerText=p.label; item.draggable=true; item.id=`d-${i}`;
                item.dataset.target = p.target;
                item.ondragstart = e => e.dataTransfer.setData('sid', e.target.id);
                dBox.appendChild(item);
            });
            const targets = [...new Set(q.pairs.map(p=>p.target))];
            targets.forEach(t => {
                const z = document.createElement('div');
                z.className='drop-zone'; z.innerHTML=`<h4>${t}</h4>`; z.dataset.match=t;
                z.ondragover = e => { e.preventDefault(); z.classList.add('hover'); };
                z.ondragleave = () => z.classList.remove('hover');
                z.ondrop = e => {
                    e.preventDefault(); z.classList.remove('hover');
                    const el = document.getElementById(e.dataTransfer.getData('sid'));
                    el.style.margin="2px"; z.appendChild(el);
                };
                zBox.appendChild(z);
            });
            area.appendChild(dBox); area.appendChild(zBox);
        } else if (q.type === 'fill') {
            document.getElementById('check-btn').classList.remove('hide');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'fill-input';
            input.id = 'fill-answer-user';
            input.placeholder = 'Nhập câu trả lời của bạn vào đây...';
            input.autocomplete = 'off';
            area.appendChild(input);
            input.focus();
            
            input.addEventListener("keypress", function(event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    document.getElementById("check-btn").click();
                }
            });

        } else {
            if(q.type === 'multi') document.getElementById('check-btn').classList.remove('hide');
            q.answers.forEach(a => {
                const btn = document.createElement('div');
                btn.className='ans-btn';
                btn.innerHTML = `${a.img ? `<img src="${a.img}" onclick="viewImage(this.src)">` : ''}<span>${a.text}</span>`;
                btn.onclick = (e) => {
                    if(e.target.tagName === 'IMG') return;
                    if(q.type === 'single') {
                        if(a.correct) { btn.classList.add('correct-show'); document.getElementById('next-btn').classList.remove('hide'); }
                        else { btn.classList.add('wrong-show'); setTimeout(()=>btn.classList.remove('wrong-show'),500); }
                    } else { btn.classList.toggle('selected'); btn.dataset.cor = a.correct; }
                }
                area.appendChild(btn);
            });
        }
    }

    function checkAnswer() {
        const q = currentQuizData[qIdx];
        let ok = true;
        if(q.type === 'multi') {
            document.querySelectorAll('.ans-btn').forEach(b => {
                const s = b.classList.contains('selected'); const c = b.dataset.cor === 'true';
                if(s !== c) ok = false;
                if(s && c) b.classList.add('correct-show');
                if(s && !c) b.classList.add('wrong-show');
            });
        } else if (q.type === 'drag') {
            document.querySelectorAll('.drop-zone').forEach(z => {
                const kids = z.querySelectorAll('.draggable');
                if(kids.length === 0) ok = false; 
                kids.forEach(k => { if(k.dataset.target !== z.dataset.match) ok = false; });
                if(ok) z.classList.add('success'); else z.classList.add('error');
            });
            if(document.querySelector('.drag-area:first-child .draggable')) ok = false;
        } else if (q.type === 'fill') {
            const userAns = document.getElementById('fill-answer-user').value.trim().toLowerCase();
            const inputField = document.getElementById('fill-answer-user');
            
            // Check against ARRAY of correct answers
            const answers = q.fillAnswers || [q.fillAnswer]; 
            const isCorrect = answers.some(ans => ans.toLowerCase() === userAns);

            if (isCorrect) {
                ok = true;
                inputField.classList.add('correct');
                inputField.readOnly = true;
            } else {
                ok = false;
                inputField.classList.add('wrong');
                setTimeout(() => inputField.classList.remove('wrong'), 1000);
            }
        }
        
        if(ok) {
            document.getElementById('next-btn').classList.remove('hide');
            document.getElementById('check-btn').classList.add('hide');
        } else {
            document.getElementById('quiz-card').classList.add('shake');
            setTimeout(() => { if(q.type !== 'fill') renderQuizQ(); }, 1500);
        }
    }

    function nextQuestion() {
        if(qIdx < currentQuizData.length - 1) { 
            qIdx++; renderQuizQ(); 
        } else { 
            showSuccessModal(); 
        }
    }

    // --- ANTI-DEBUGGING ---
    document.addEventListener('keydown', function(e) {
        if (e.keyCode === 123) { e.preventDefault(); return false; }
        if (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74 || e.keyCode === 67)) { e.preventDefault(); return false; }
        if (e.ctrlKey && e.keyCode === 85) { e.preventDefault(); return false; }
    });
    document.addEventListener('contextmenu', function(e) { e.preventDefault(); }, false);

</script>
</body>
</html>
