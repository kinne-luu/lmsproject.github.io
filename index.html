<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS - Project</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon"
        href="https://pub-c498a98c7a3843c7b4440a03435217a3.r2.dev/thumbnail/cut.png">
    <style>
        :root {
            /* --- DARK THEME PALETTE --- */
            --bg-gradient: linear-gradient(135deg, #0f172a, #1e293b);
            --panel-bg: rgba(30, 41, 59, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);

            --text-main: #f1f5f9;
            --text-muted: #94a3b8;

            --accent: #fbbf24;

            --danger: #ef4444;
            --success: #22c55e;
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-main);
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* --- ADMIN BADGE --- */
        body.admin-mode::after {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 99999;
            pointer-events: none;
            box-shadow: inset 0 0 0 4px var(--danger), inset 0 0 30px rgba(239, 68, 68, 0.4);
            animation: pulseRedSoft 2s infinite alternate;
        }

        @keyframes pulseRedSoft {
            from {
                box-shadow: inset 0 0 0 4px var(--danger), inset 0 0 15px rgba(239, 68, 68, 0.1);
            }

            to {
                box-shadow: inset 0 0 0 4px var(--danger), inset 0 0 40px rgba(239, 68, 68, 0.5);
            }
        }

        #admin-badge {
            display: none;
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: var(--danger);
            color: white;
            padding: 5px 25px;
            font-weight: 800;
            font-size: 0.8em;
            letter-spacing: 1px;
            text-transform: uppercase;
            z-index: 20001;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.5);
        }

        body.admin-mode #admin-badge {
            display: block;
        }

        #admin-toast {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(15px);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 15px 40px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 20000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transition: top 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        #admin-toast.show {
            top: 80px;
        }

        .admin-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
            color: var(--text-main);
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            z-index: 9999;
            padding: 10px 20px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s ease;
            font-weight: 600;
            font-size: 0.85em;
        }

        .admin-toggle:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: #000;
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.4);
        }

        /* --- LAYOUT --- */
        .container {
            max-width: 900px;
            margin: 0 auto;
            margin-top: 60px;
            padding-bottom: 50px;
        }

        .screen {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(16px);
            border: var(--glass-border);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        h1,
        h2,
        h3,
        h4 {
            color: var(--text-main);
            margin-top: 0;
            font-weight: 800;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: 0.3s;
            text-align: center;
        }

        .card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent);
        }

        .card i {
            font-size: 2em;
            margin-bottom: 10px;
            color: var(--accent);
            transition: 0.3s;
        }

        /* --- BLOOM EFFECT --- */
        .card:hover i {
            color: #fff;
            text-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent), 0 0 40px var(--accent);
            transform: scale(1.15);
        }

        /* --- FORMS --- */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--accent);
            font-size: 0.9em;
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.4) !important;
            color: white !important;
            box-sizing: border-box;
            font-family: inherit;
            transition: 0.2s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: var(--accent);
            outline: none;
            background: rgba(0, 0, 0, 0.6) !important;
        }

        select option {
            background-color: #1e293b;
            color: white;
        }

        /* --- UPDATED: OPTION ROW FOR TEXTAREA --- */
        .opt-row {
            padding: 10px 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: flex-start;
            /* Canh lề trên để đẹp với textarea */
            gap: 15px;
        }

        /* Style cho textarea nhập đáp án */
        textarea.opt-text-val {
            background: transparent !important;
            border: none !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3) !important;
            border-radius: 0 !important;
            width: 100%;
            color: white !important;
            font-family: 'Inter', sans-serif;
            resize: none;
            /* Tắt kéo thủ công */
            overflow: hidden;
            /* Ẩn thanh cuộn */
            min-height: 28px;
            /* Chiều cao tối thiểu */
            line-height: 1.5;
            padding: 5px 0;
            transition: border-color 0.2s;
        }

        textarea.opt-text-val:focus {
            border-bottom: 2px solid var(--accent) !important;
            outline: none;
            background: rgba(255, 255, 255, 0.02) !important;
        }

        /* Input ảnh nhỏ gọn bên cạnh */
        .opt-img-input {
            width: 30% !important;
            font-size: 0.85em;
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            height: 35px;
            /* Chiều cao cố định cho input ảnh */
        }

        /* --- DRAG EDITOR STYLES --- */
        .drag-group-editor {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .drag-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 8px;
        }

        .drag-items-list {
            margin-top: 10px;
            padding-left: 15px;
            border-left: 2px solid var(--accent);
        }

        .drag-item-row {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }

        /* --- BUTTONS --- */
        .btn-primary {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 12px 30px;
            font-weight: 700;
            border-radius: 30px;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-primary:hover {
            background: #fff;
            transform: translateY(-2px);
            box-shadow: 0 0 15px var(--accent);
        }

        .btn-danger {
            background: transparent;
            color: var(--danger);
            border: 1px solid var(--danger);
            padding: 10px 25px;
            font-weight: 600;
            border-radius: 30px;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-danger:hover {
            background: var(--danger);
            color: white;
        }

        .btn-add {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed rgba(255, 255, 255, 0.3);
            color: #ccc;
            cursor: pointer;
            border-radius: 8px;
            margin-top: 10px;
            font-weight: 600;
            transition: 0.2s;
        }

        .btn-add:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--accent);
            border-color: var(--accent);
        }

        .btn-icon {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.4);
            cursor: pointer;
            font-size: 1.2em;
            transition: 0.2s;
            margin-top: 5px;
        }

        .btn-icon:hover {
            color: var(--danger);
            transform: scale(1.2);
        }

        .btn-error-flash {
            animation: flashRedBtn 0.5s ease-in-out;
        }

        @keyframes flashRedBtn {

            0%,
            100% {
                border-color: var(--accent);
                color: #000;
                background: var(--accent);
            }

            50% {
                border-color: var(--danger);
                color: var(--danger);
                background: transparent;
                transform: scale(1.05);
                box-shadow: 0 0 15px var(--danger);
            }
        }

        #save-error-msg {
            color: var(--danger);
            font-size: 0.9em;
            margin-top: 10px;
            font-weight: 700;
            text-align: right;
            min-height: 1.2em;
            display: block;
        }

        /* MIX BUTTON STYLE */
        .btn-mix-all {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 8px;
            background: linear-gradient(45deg, #3b82f6, #2563eb);
            color: white;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.95em;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
            transition: 0.3s;
        }

        .btn-mix-all:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(37, 99, 235, 0.5);
            filter: brightness(1.1);
        }

        /* --- QUIZ UI --- */
        .ans-btn {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 96%;
            margin: 0 auto 12px auto;
            padding: 18px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            border-radius: 12px;
            cursor: pointer;
            transition: 0.2s;
            font-weight: 500;
        }

        .ans-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .ans-btn.selected {
            background: rgba(251, 191, 36, 0.2);
            border-color: var(--accent);
            color: var(--accent);
            font-weight: 700;
        }

        .ans-btn.correct-show {
            background: rgba(34, 197, 94, 0.2);
            border-color: var(--success);
            color: var(--success);
        }

        .ans-btn.wrong-show {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--danger);
            color: var(--danger);
        }

        /* TRUE/FALSE UI */
        .tf-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            gap: 15px;
        }

        .tf-text {
            flex: 1;
            font-weight: 500;
        }

        .tf-btns {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .tf-btn-opt {
            padding: 6px 16px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }

        .tf-btn-opt:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .tf-btn-opt.selected[data-val="true"] {
            background: rgba(34, 197, 94, 0.2);
            border-color: var(--success);
            color: var(--success);
        }

        .tf-btn-opt.selected[data-val="false"] {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--danger);
            color: var(--danger);
        }

        .tf-row.tf-correct {
            border: 1px solid var(--success);
            background: rgba(34, 197, 94, 0.05);
        }

        .tf-row.tf-wrong {
            border: 1px solid var(--danger);
            background: rgba(239, 68, 68, 0.05);
        }

        .shuffling {
            animation: shuffleEffect 0.6s ease-in-out;
            pointer-events: none;
        }

        @keyframes shuffleEffect {
            0% {
                opacity: 1;
                filter: blur(0);
            }

            50% {
                opacity: 0.5;
                filter: blur(4px);
            }

            100% {
                opacity: 1;
                filter: blur(0);
            }
        }

        /* Review Styles */
        .review-q-block {
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 20px;
        }

        .review-q-block h3 {
            color: var(--accent);
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .review-ans {
            padding: 10px 12px;
            margin-bottom: 6px;
            border-radius: 8px;
            font-size: 0.95em;
            color: var(--text-muted);
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .review-ans.correct-highlight {
            color: var(--success);
            border: 1px solid var(--success);
            background: rgba(34, 197, 94, 0.1);
            font-weight: 700;
        }

        .review-ans.normal-opt {
            opacity: 0.7;
        }

        .ans-btn img,
        .review-ans img {
            max-width: 75%;
            height: auto;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            object-fit: contain;
            margin-right: 10px;
            order: -1;
            cursor: zoom-in;
        }

        #display-q-img {
            max-width: 100% !important;
            height: auto;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: none;
            margin: 10px 0;
            cursor: zoom-in;
        }

        /* DRAG UI */
        .drag-area {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 20px 0;
        }

        .draggable {
            background: #1e293b;
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: grab;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .drop-zone {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            min-width: 150px;
            min-height: 100px;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .drop-zone h4 {
            color: var(--text-muted);
            margin-bottom: 10px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .drop-zone.hover {
            border-color: var(--accent);
            background: rgba(251, 191, 36, 0.1);
        }

        .drop-zone.success {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }

        .drop-zone.error {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        /* Fill In Blank */
        .fill-input {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .fill-input:focus {
            border-color: var(--accent);
            outline: none;
        }

        .fill-input.correct {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }

        .fill-input.wrong {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        /* LIST & BUTTONS */
        #questions-list {
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 5px;
        }

        .q-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid transparent;
            transition: 0.2s;
        }

        .q-item:hover {
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.03);
        }

        .q-item-content {
            flex: 1;
            display: flex;
            align-items: center;
            overflow: hidden;
            padding-right: 10px;
        }

        .q-item-content span:last-child {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .q-num {
            color: var(--text-muted);
            font-weight: bold;
            font-size: 0.8em;
            margin-right: 10px;
            min-width: 35px;
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 4px;
            transition: 0.2s;
            border: 1px solid transparent;
        }

        .q-num:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent);
            color: var(--accent);
        }

        .q-num input::-webkit-outer-spin-button,
        .q-num input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .q-num input[type=number] {
            -moz-appearance: textfield;
        }

        .q-num input {
            width: 40px !important;
            padding: 2px !important;
            height: 20px;
            font-size: 1em;
            text-align: center;
            background: #0f172a !important;
            border: 1px solid var(--accent);
            color: white !important;
        }

        .btn-group {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85em;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-left: 5px;
            color: #ccc;
            border-radius: 6px;
            background: transparent !important;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-sm:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(251, 191, 36, 0.05) !important;
        }

        .badge {
            font-size: 0.7em;
            padding: 3px 8px;
            border-radius: 4px;
            margin-right: 10px;
            font-weight: 700;
            background: rgba(255, 255, 255, 0.1);
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .preview-img {
            max-height: 40px;
            border-radius: 4px;
            border: 1px solid #555;
            margin-left: 10px;
        }

        .hide {
            display: none !important;
        }

        .shake {
            animation: shakeAnim 0.4s;
        }

        @keyframes shakeAnim {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        #loading {
            text-align: center;
            padding: 20px;
            color: var(--accent);
            font-style: italic;
            display: none;
        }

        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        #q-search {
            padding-left: 35px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* --- VIEWER & MODALS --- */
        #image-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 50000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #image-viewer.active {
            opacity: 1;
            pointer-events: all;
        }

        #full-image {
            max-width: 90vw;
            max-height: 90vh;
            transition: transform 0.1s linear;
            cursor: grab;
        }

        .close-viewer {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 2em;
            cursor: pointer;
            background: none;
            border: none;
            z-index: 50001;
        }

        #success-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 60000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        #success-modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: #1e293b;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 350px;
        }

/* --- CHẾ ĐỘ HIỂN THỊ LƯỚI CHO ĐÁP ÁN CÓ ẢNH --- */
        #quiz-options-area.grid-mode {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 98%;
            margin: 0 auto;
        }

        #quiz-options-area.grid-mode .ans-btn {
            width: auto !important;
            margin: 0 !important;
            flex-direction: column !important;
            justify-content: space-between;
            text-align: center;
            min-height: 200px; /* Tăng chiều cao để chứa ảnh to hơn */
            padding: 20px 15px;
            box-sizing: border-box;
        }

        #quiz-options-area.grid-mode .ans-btn img {
            max-width: 95%;
            max-height: 160px !important; /* Tăng kích thước ảnh tối đa */
            width: auto;
            height: auto;
            margin: 0 auto 15px auto !important;
            order: 0 !important;
            display: block;
            object-fit: contain;
            border-radius: 8px; /* Bo góc nhẹ cho ảnh đồ thị trông mượt hơn */
        }

        /* Responsive: Màn hình điện thoại nhỏ thì về lại 1 cột cho dễ nhìn */
        @media (max-width: 600px) {
            #quiz-options-area.grid-mode {
                grid-template-columns: 1fr; 
            }
        }

    </style>
</head>

<body>

    <div id="image-viewer">
        <button class="close-viewer" onclick="closeImageViewer()"><i class="fas fa-times"></i></button>
        <div id="viewer-container" onmousedown="startDrag(event)">
            <img id="full-image" src="">
        </div>
    </div>

    <div id="success-modal">
        <div class="modal-content">
            <h3 style="color: var(--success); margin-bottom: 10px; font-size: 1.5em;">Hoàn thành!</h3>
            <p style="color: var(--text-muted); margin-bottom: 25px;">Bạn đã trả lời hết các câu hỏi.</p>
            <button class="btn-primary" onclick="closeSuccessModal()">Xem kết quả</button>
        </div>
    </div>

    <div id="admin-badge">Endmin Mode</div>
    <div id="admin-toast">
        <i class="fas fa-check-circle" style="color: var(--success);"></i>
        <span>Welcome back, Endministrator</span>
    </div>

    <button class="admin-toggle" onclick="toggleAdmin()">
        <i class="fas fa-user-shield"></i>
        <span>Endministrator</span>
    </button>

    <div class="container">
        <section id="home-screen" class="screen active">
            <div class="glass-panel" style="text-align: center;">
                <h1 style="color: var(--accent); font-size: 2em; margin-bottom: 10px;">HỆ THỐNG TRẮC NGHIỆM</h1>
                <p style="color: var(--text-muted); margin-bottom: 30px;">Chọn môn học để bắt đầu ôn tập</p>
                <div class="grid" id="subjects-grid"></div>
            </div>
        </section>

        <section id="lesson-screen" class="screen">
            <div class="glass-panel">
                <button onclick="goHome()"
                    style="background:none; border:none; color:var(--text-muted); cursor:pointer; margin-bottom:20px; font-weight: 600;">
                    <i class="fas fa-arrow-left"></i> Quay lại trang chủ
                </button>
                <h2 id="current-subject-title" style="color: var(--accent);">Tên Môn</h2>
                <p id="admin-hint" class="hide"
                    style="color:var(--danger); font-weight:600; background: rgba(239, 68, 68, 0.1); display: inline-block; padding: 5px 15px; border-radius: 20px; border: 1px solid var(--danger);">
                    [Đang ở chế độ chỉnh sửa]</p>

                <div class="grid" id="lessons-grid"></div>

                <div style="margin-top: 25px; text-align: right;">
                    <button id="btn-mix-all-lessons" class="btn-mix-all" onclick="mixAllLessons()">
                        <i class="fas fa-random"></i> Trộn tất cả câu hỏi
                    </button>
                </div>
            </div>
        </section>

        <section id="quiz-screen" class="screen">
            <div class="glass-panel" id="quiz-card">
                <div
                    style="display:flex; justify-content:space-between; align-items:center; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <span id="progress" style="font-weight: 700; color: var(--accent);">Câu 1</span>
                    <div style="display:flex; align-items:center; gap: 15px;">

                        <button onclick="enableStudyMode()" class="btn-sm"
                            style="color: #fff; border-color: #3b82f6; background: rgba(59,130,246,0.2) !important;">
                            <i class="fas fa-eye"></i> <span>Ôn tập nhanh</span>
                        </button>

                        <button onclick="shuffleAndRestart()" class="btn-sm"
                            style="color: var(--accent); border-color: var(--accent); display:flex; gap:5px; align-items:center;">
                            <i class="fas fa-random"></i> <span>Trộn câu hỏi</span>
                        </button>
                        <span onclick="goBackToLessons()"
                            style="cursor:pointer; color: var(--text-muted); font-size: 0.9em;">Thoát bài tập</span>
                    </div>
                </div>

                <div id="loading">Đang tải dữ liệu...</div>

                <div id="quiz-content">
                    <h3 id="display-q-text" style="margin: 20px 0; font-weight: 600; font-size: 1.3em;"></h3>
                    <div style="text-align:left; margin-bottom:20px;">
                        <img id="display-q-img" src="" onclick="viewImage(this.src)" alt="Question Image">
                    </div>
                    <div id="quiz-options-area"></div>
                    <div style="margin-top: 30px; text-align: right;">
                        <button id="check-btn" class="btn-primary hide" onclick="checkAnswer()">Kiểm tra đáp án</button>
                        <button id="next-btn" class="btn-primary hide" onclick="nextQuestion()">Câu tiếp theo <i
                                class="fas fa-arrow-right"></i></button>
                    </div>
                </div>

                <div id="review-content" class="hide">
                    <h2 style="color: var(--success); text-align: center; margin-bottom: 30px;">Xem lại đáp án</h2>
                    <div id="review-list"></div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn-primary" onclick="goBackToLessons()">Hoàn thành & Thoát</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="admin-editor-screen" class="screen">
            <div class="glass-panel">
                <div
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px;">
                    <h3 id="editor-title" style="margin:0; color: var(--accent);">Trình chỉnh sửa</h3>
                    <button onclick="goBackToLessons()" class="btn-danger">Đóng</button>
                </div>

                <div id="editor-form-wrapper"
                    style="background: rgba(0,0,0,0.3); padding: 25px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.05);">
                    <h4 id="form-header" style="margin-top:0; color:var(--text-main);">Thêm câu hỏi mới</h4>
                    <div class="form-group">
                        <label>Loại câu hỏi</label>
                        <select id="q-type" onchange="renderOptionsForm()">
                            <option value="single">Chọn 1 đáp án (Single)</option>
                            <option value="multi">Chọn nhiều đáp án (Multi)</option>
                            <option value="tf">Đúng / Sai (True/False)</option>
                            <option value="drag">Kéo thả (Drag & Drop)</option>
                            <option value="fill">Điền từ (Fill in blank)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Nội dung câu hỏi (Đầu bài chung)</label>
                        <textarea id="q-text" rows="2" placeholder="Nhập câu hỏi..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Hình ảnh (Tùy chọn)</label>
                        <div style="display:flex; align-items:center;">
                            <input type="text" id="q-img" placeholder="Dán link ảnh vào đây..."
                                oninput="previewImage(this, 'editor-prev')">
                            <img id="editor-prev" class="preview-img" src="" style="display:none;">
                        </div>
                    </div>

                    <div id="options-container" style="margin-top:20px;"></div>
                    <button id="add-opt-btn" class="btn-add" onclick="addNewOptionRow()">+ Thêm dòng đáp án</button>

                    <div style="margin-top:30px; text-align:right;">
                        <div style="display: flex; justify-content: flex-end; gap: 10px;">
                            <button class="btn-danger" style="border:1px solid rgba(255,255,255,0.2); color: #ccc;"
                                onclick="resetForm()">Hủy / Làm mới</button>
                            <button id="btn-save-q" class="btn-primary" onclick="saveQuestion()">Lưu câu hỏi</button>
                        </div>
                        <div id="save-error-msg"></div>
                    </div>
                </div>

                <h4
                    style="margin-top: 40px; color: var(--text-muted); display:flex; justify-content:space-between; align-items:center;">
                    <span>Danh sách câu hỏi (<span id="list-count">0</span>)</span>
                </h4>

                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="q-search" placeholder="Tìm kiếm câu hỏi..." oninput="renderQuestionList()">
                </div>

                <div id="questions-list"></div>

                <div style="margin-top:30px; text-align:center;">
                    <button class="btn-primary"
                        style="background: transparent; border: 1px solid var(--success); color: var(--success);"
                        onclick="exportJSON()"><i class="fas fa-download"></i> Tải file dữ liệu (.JSON)</button>
                </div>
            </div>
        </section>
    </div>

    <script>
        const subjects = [
            { id: 'kinhte', name: 'Kinh tế chính trị Mác - Lê Nin', icon: 'fa-book', lessons: 6 },
            { id: 'laptrinhC', name: 'Lập trình C Nâng cao', icon: 'fa-code', lessons: 9 },
            { id: 'thongtinso', name: 'Thông tin Số', icon: 'fa-network-wired', lessons: 9 },
            { id: 'truyensolieu', name: 'Kỹ thuật truyền số liệu', icon: 'fa-satellite-dish', lessons: 9 },
            { id: 'maydien', name: 'Máy điện', icon: 'fa-bolt', lessons: 9 }
        ];

        let currentSubjectId = null;
        let currentLessonId = null;
        let isAdminMode = false;
        let currentQuizData = [];
        let editingIndex = -1;
        let currentSubjectObj = null;

        // --- ZOOM VARS ---
        let imgScale = 1; let imgTranslateX = 0; let imgTranslateY = 0;
        let isDraggingImg = false; let startDragX, startDragY;

        function init() {
            const grid = document.getElementById('subjects-grid');
            grid.innerHTML = "";
            subjects.forEach(sub => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<i class="fas ${sub.icon}"></i><h3>${sub.name}</h3>`;
                card.onclick = () => openLessons(sub);
                grid.appendChild(card);
            });
            document.getElementById('image-viewer').addEventListener('wheel', handleZoom, { passive: false });
            document.getElementById('image-viewer').addEventListener('click', function (e) {
                if (e.target.id === 'image-viewer' || e.target.id === 'viewer-container') closeImageViewer();
            });

            window.addEventListener('mousemove', dragImage);
            window.addEventListener('mouseup', stopDragImage);
        }
        init();

        // --- IMAGE VIEWER ---
        function viewImage(src) {
            if (window.event) window.event.stopPropagation();
            const viewer = document.getElementById('image-viewer');
            const img = document.getElementById('full-image');
            img.src = src;
            imgScale = 1; imgTranslateX = 0; imgTranslateY = 0;
            updateImageTransform();
            viewer.classList.add('active');
        }
        function closeImageViewer() { document.getElementById('image-viewer').classList.remove('active'); }
        function handleZoom(e) {
            e.preventDefault(); const zoomStep = 0.1;
            if (e.deltaY < 0) imgScale += zoomStep; else imgScale -= zoomStep;
            imgScale = Math.min(Math.max(0.5, imgScale), 5);
            updateImageTransform();
        }
        function startDrag(e) {
            if (e.target.id !== 'full-image' && e.target.id !== 'viewer-container') return;
            isDraggingImg = true; startDragX = e.clientX - imgTranslateX; startDragY = e.clientY - imgTranslateY;
            document.getElementById('full-image').style.cursor = 'grabbing';
        }
        function dragImage(e) {
            if (!isDraggingImg) return; e.preventDefault();
            imgTranslateX = e.clientX - startDragX; imgTranslateY = e.clientY - startDragY;
            updateImageTransform();
        }
        function stopDragImage() { isDraggingImg = false; document.getElementById('full-image').style.cursor = 'grab'; }
        function updateImageTransform() { document.getElementById('full-image').style.transform = `translate(${imgTranslateX}px, ${imgTranslateY}px) scale(${imgScale})`; }

        // --- UTILS ---
        function scrollToTop() {
            const container = document.querySelector('.container');
            if (container) container.scrollIntoView({ behavior: 'smooth' });
            else window.scrollTo(0, 0);
        }
        function showSuccessModal() { document.getElementById('success-modal').classList.add('active'); }
        function closeSuccessModal() { document.getElementById('success-modal').classList.remove('active'); showReviewScreen(); }

        // --- NAVIGATION & LOAD ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        function goHome() { currentSubjectId = null; showScreen('home-screen'); }
        function goBackToLessons() {
            if (currentSubjectId) openLessons(subjects.find(s => s.id === currentSubjectId));
            else goHome();
        }
        function toggleAdmin() {
            if (isAdminMode) {
                isAdminMode = false; document.body.classList.remove('admin-mode');
                showToast("Endmin log out", false); goHome();
            } else {
                if (prompt("Nhập mật khẩu:") === "2006") {
                    isAdminMode = true; document.body.classList.add('admin-mode');
                    showToast("Welcome back, Endministrator"); goHome();
                } else alert("Sai mật khẩu");
            }
        }
        function showToast(msg) {
            const toast = document.getElementById('admin-toast');
            toast.querySelector('span').innerText = msg;
            toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 1000);
        }

        function openLessons(subject) {
            currentSubjectId = subject.id;
            currentSubjectObj = subject;
            document.getElementById('current-subject-title').innerText = subject.name;
            document.getElementById('admin-hint').classList.toggle('hide', !isAdminMode);

            const mixBtnContainer = document.querySelector('#lesson-screen .glass-panel > div:last-child');
            if (mixBtnContainer) mixBtnContainer.style.display = isAdminMode ? 'none' : 'block';

            const grid = document.getElementById('lessons-grid'); grid.innerHTML = "";
            for (let i = 1; i <= subject.lessons; i++) {
                const card = document.createElement('div');
                card.className = 'card'; card.innerHTML = `<h3 style="margin-top:5px;">Bài ${i}</h3>`;
                card.onclick = () => { currentLessonId = i; smartLoadData(currentSubjectId, i); };
                grid.appendChild(card);
            }
            showScreen('lesson-screen');
        }

        async function mixAllLessons() {
            if (!currentSubjectObj) return;
            document.getElementById('loading').style.display = 'block';
            resetQuizUI();

            showScreen('quiz-screen');

            currentQuizData = [];
            const promises = [];

            const timestamp = new Date().getTime();
            for (let i = 1; i <= currentSubjectObj.lessons; i++) {
                const jsonPath = `data/${currentSubjectId}/bai${i}.json?t=${timestamp}`;
                const p = fetch(jsonPath)
                    .then(res => { if (res.ok) return res.json(); return []; })
                    .catch(() => []);
                promises.push(p);
            }

            try {
                const results = await Promise.all(promises);
                results.forEach(data => {
                    if (Array.isArray(data)) currentQuizData = currentQuizData.concat(data);
                });

                if (currentQuizData.length === 0) {
                    alert("Không tìm thấy dữ liệu nào để trộn!");
                    goBackToLessons();
                } else {
                    shuffleArray(currentQuizData);
                    startQuiz();
                }
            } catch (e) {
                alert("Lỗi khi trộn dữ liệu!");
                goBackToLessons();
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function resetQuizUI() {
            document.getElementById('quiz-content').style.display = 'none';
            document.getElementById('review-content').classList.add('hide');
            document.getElementById('check-btn').classList.add('hide');
            document.getElementById('next-btn').classList.add('hide');
        }

        async function smartLoadData(subId, lesId) {
            currentQuizData = [];
            const localKey = `quiz_${subId}_${lesId}`;
            const jsonPath = `data/${subId}/bai${lesId}.json?t=${new Date().getTime()}`;

            if (isAdminMode) {
                const raw = localStorage.getItem(localKey);
                if (raw && JSON.parse(raw).length > 0) {
                    currentQuizData = JSON.parse(raw);
                    openAdminEditor();
                } else {
                    try {
                        const response = await fetch(jsonPath);
                        if (response.ok) currentQuizData = await response.json();
                    } catch (error) { console.log("Không tìm thấy dữ liệu gốc"); }
                    openAdminEditor();
                }
            } else {
                document.getElementById('loading').style.display = 'block';
                resetQuizUI();
                showScreen('quiz-screen');
                try {
                    const response = await fetch(jsonPath);
                    if (!response.ok) throw new Error("File not found");
                    currentQuizData = await response.json();
                    startQuiz();
                } catch (error) {
                    const raw = localStorage.getItem(localKey);
                    if (raw) { currentQuizData = JSON.parse(raw); startQuiz(); }
                    else { alert("Bài học này chưa có dữ liệu!"); goBackToLessons(); }
                } finally { document.getElementById('loading').style.display = 'none'; }
            }
        }
        function saveQuizData() { localStorage.setItem(`quiz_${currentSubjectId}_${currentLessonId}`, JSON.stringify(currentQuizData)); }

        // --- EDITOR LOGIC ---
        function openAdminEditor() {
            showScreen('admin-editor-screen');
            document.getElementById('editor-title').innerText = `Chỉnh sửa: ${currentSubjectId} / Bài ${currentLessonId}`;
            resetForm(); renderQuestionList();
        }
        function resetForm() {
            editingIndex = -1; document.getElementById('form-header').innerText = "Thêm câu hỏi mới";
            document.getElementById('q-text').value = ""; document.getElementById('q-img').value = "";
            document.getElementById('editor-prev').style.display = 'none'; renderOptionsForm();
            document.getElementById('save-error-msg').innerText = "";
        }
        function previewImage(input, imgId) {
            const img = document.getElementById(imgId);
            if (input.value) { img.src = input.value; img.style.display = "block"; } else { img.style.display = "none"; }
        }

        // --- DRAG EDITOR HELPER ---
        function addDragGroupRow(groupData = null) {
            const container = document.getElementById('options-container');
            const groupDiv = document.createElement('div');
            groupDiv.className = 'drag-group-editor';

            const zoneName = groupData ? groupData.zone : '';
            const items = groupData ? groupData.items : [''];

            let itemsHtml = '';
            items.forEach(itm => {
                itemsHtml += `
            <div class="drag-item-row">
                <input type="text" class="drag-item-input" value="${itm}" placeholder="Nội dung đáp án thả vào..." style="flex:1">
                <button class="btn-icon" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
            </div>`;
            });

            groupDiv.innerHTML = `
            <div class="drag-group-header">
                <input type="text" class="drag-zone-name" value="${zoneName}" placeholder="Tên ô câu hỏi con (VD: Nhóm A)" style="font-weight:700; color:var(--accent) !important;">
                <button class="btn-icon" style="color:var(--danger)" onclick="this.closest('.drag-group-editor').remove()"><i class="fas fa-trash"></i></button>
            </div>
            <div class="drag-items-list">
                <div class="drag-items-container">${itemsHtml}</div>
                <button class="btn-sm" onclick="addDragItemInput(this)">+ Thêm đáp án cho ô này</button>
            </div>
        `;
            container.appendChild(groupDiv);
        }

        function addDragItemInput(btn) {
            const container = btn.previousElementSibling;
            const div = document.createElement('div');
            div.className = 'drag-item-row';
            div.innerHTML = `
            <input type="text" class="drag-item-input" placeholder="Nội dung đáp án thả vào..." style="flex:1">
            <button class="btn-icon" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
        `;
            container.appendChild(div);

            const newInput = div.querySelector('.drag-item-input');
            newInput.focus();

            newInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addDragItemInput(btn);
                }
            });
        }

        // --- RENDER FORM ---
        function renderOptionsForm(presetType = null) {
            const type = presetType || document.getElementById('q-type').value;
            const container = document.getElementById('options-container');
            const addBtn = document.getElementById('add-opt-btn');

            container.innerHTML = "";

            if (type === 'drag') {
                addBtn.innerText = "+ Thêm Ô câu hỏi con (Nhóm)";
                addBtn.onclick = () => addDragGroupRow();
                if (editingIndex === -1) { addDragGroupRow(); addDragGroupRow(); }
            } else if (type === 'fill') {
                addBtn.innerText = "+ Thêm dòng đáp án";
                addBtn.onclick = () => addFillOptionRow();
                if (editingIndex === -1) addFillOptionRow();
            } else if (type === 'tf') {
                addBtn.innerText = "+ Thêm câu hỏi đúng sai";
                addBtn.onclick = () => addTFOptionRow();
                if (editingIndex === -1) { addTFOptionRow(); }
            } else {
                addBtn.innerText = "+ Thêm dòng đáp án";
                addBtn.onclick = () => addNewOptionRow();
                if (editingIndex === -1) {
                    if (type === 'single') { addNewOptionRow(); addNewOptionRow(); addNewOptionRow(); addNewOptionRow(); }
                    else { addNewOptionRow(); addNewOptionRow(); }
                }
            }
        }

        function addFillOptionRow(value = '') {
            const container = document.getElementById('options-container');
            const div = document.createElement('div'); div.className = 'opt-row';
            div.innerHTML = `
            <label style="width:auto; margin:0; color:var(--success); margin-right:10px;">Đáp án:</label>
            <input type="text" class="fill-option-text" value="${value}" placeholder="Nhập đáp án chấp nhận..." style="flex:1">
            <button class="btn-icon" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
        `;
            container.appendChild(div);

            const input = div.querySelector('.fill-option-text');
            input.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addFillOptionRow();
                    const allInputs = document.querySelectorAll('.fill-option-text');
                    allInputs[allInputs.length - 1].focus();
                }
            });
        }

        function addTFOptionRow(data = null) {
            const container = document.getElementById('options-container');
            const div = document.createElement('div'); div.className = 'opt-row';
            const txt = data ? data.text : '';
            const val = data ? (data.correct ? 'true' : 'false') : 'true';
            div.innerHTML = `
            <input type="text" class="tf-text" value="${txt}" placeholder="Nội dung câu hỏi con..." style="flex:1">
            <select class="tf-correct-input" style="width: 100px; background: rgba(0,0,0,0.4) !important;">
                <option value="true" ${val === 'true' ? 'selected' : ''}>Đúng</option>
                <option value="false" ${val === 'false' ? 'selected' : ''}>Sai</option>
            </select>
            <button class="btn-icon" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
        `;
            container.appendChild(div);

            const input = div.querySelector('.tf-text');
            input.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTFOptionRow();
                    const allInputs = document.querySelectorAll('.tf-text');
                    allInputs[allInputs.length - 1].focus();
                }
            });
        }

        // --- MAIN OPTION ROW LOGIC (UPDATED FOR TEXTAREA & ENTER) ---
        function addNewOptionRow(data = null) {
            const type = document.getElementById('q-type').value;
            const container = document.getElementById('options-container');
            const div = document.createElement('div'); div.className = 'opt-row';

            const itype = type === 'single' ? 'radio' : 'checkbox';
            const chk = data ? (data.correct ? 'checked' : '') : '';
            const txt = data ? data.text : '';
            const img = data ? (data.img || '') : '';

            div.innerHTML = `
            <input type="${itype}" name="cor" class="correct-chk" ${chk} style="transform:scale(1.5); cursor:pointer; accent-color: var(--accent); margin-top:8px;">
            <div style="flex:1; display:flex; gap:10px; align-items:flex-start;">
                <textarea class="opt-text-val" rows="1" placeholder="Nhập đáp án..." oninput="autoResize(this)">${txt}</textarea>
                <input type="text" class="opt-img-input" value="${img}" placeholder="Link ảnh...">
            </div>
            <button class="btn-icon" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
        `;
            container.appendChild(div);

            // --- Handle Enter Key Logic ---
            const txtArea = div.querySelector('.opt-text-val');

            // Init resize
            if (txt) autoResize(txtArea);

            txtArea.addEventListener('keydown', function (e) {
                // Enter but NO Shift => Go to next field or create new
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();

                    const allTextAreas = document.querySelectorAll('.opt-text-val');
                    const currentIndex = Array.from(allTextAreas).indexOf(this);

                    // If there is a next row
                    if (currentIndex < allTextAreas.length - 1) {
                        allTextAreas[currentIndex + 1].focus();
                    } else {
                        // Create new row
                        addNewOptionRow();
                        // Wait for DOM then focus
                        setTimeout(() => {
                            const newAll = document.querySelectorAll('.opt-text-val');
                            newAll[newAll.length - 1].focus();
                        }, 10);
                    }
                }
                // Shift + Enter => Default behavior (new line) -> handled natively by textarea
            });

            // Also allow Enter on image input to create new row
            const imgInput = div.querySelector('.opt-img-input');
            imgInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addNewOptionRow();
                    setTimeout(() => {
                        const newAll = document.querySelectorAll('.opt-text-val');
                        newAll[newAll.length - 1].focus();
                    }, 10);
                }
            });
        }

        // Auto resize textarea
        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        function showSaveError(msg) {
            const errDiv = document.getElementById('save-error-msg');
            const btn = document.getElementById('btn-save-q');
            errDiv.innerText = msg;
            btn.classList.add('btn-error-flash'); setTimeout(() => btn.classList.remove('btn-error-flash'), 500);
        }

        function saveQuestion() {
            document.getElementById('save-error-msg').innerText = "";
            const type = document.getElementById('q-type').value;
            const text = document.getElementById('q-text').value.trim();
            const img = document.getElementById('q-img').value.trim();

            if (!text && !img) return showSaveError("Vui lòng nhập nội dung hoặc hình ảnh!");
            let newQ = { type, text, img: img || null };

            if (type === 'drag') {
                newQ.groups = [];
                const groupDivs = document.querySelectorAll('.drag-group-editor');
                groupDivs.forEach(g => {
                    const zone = g.querySelector('.drag-zone-name').value.trim();
                    const items = [];
                    g.querySelectorAll('.drag-item-input').forEach(i => {
                        if (i.value.trim()) items.push(i.value.trim());
                    });
                    if (zone && items.length > 0) newQ.groups.push({ zone, items });
                });
                if (newQ.groups.length < 1) return showSaveError("Cần ít nhất 1 nhóm và đáp án!");
            }
            else if (type === 'fill') {
                newQ.fillAnswers = [];
                document.querySelectorAll('.fill-option-text').forEach(inp => { if (inp.value.trim()) newQ.fillAnswers.push(inp.value.trim()); });
                if (newQ.fillAnswers.length === 0) return showSaveError("Cần ít nhất 1 đáp án điền từ!");
            }
            else if (type === 'tf') {
                newQ.items = [];
                document.querySelectorAll('.opt-row').forEach(r => {
                    const txt = r.querySelector('.tf-text').value.trim();
                    const val = r.querySelector('.tf-correct-input').value === 'true';
                    if (txt) newQ.items.push({ text: txt, correct: val });
                });
                if (newQ.items.length === 0) return showSaveError("Cần ít nhất 1 câu hỏi đúng sai!");
            }
            else {
                newQ.answers = []; let correctCount = 0;
                document.querySelectorAll('.opt-row').forEach(r => {
                    const txt = r.querySelector('.opt-text-val').value.trim();
                    const i = r.querySelector('.opt-img-input').value.trim();
                    const c = r.querySelector('.correct-chk').checked;
                    if (txt || i) { newQ.answers.push({ text: txt, img: i || null, correct: c }); if (c) correctCount++; }
                });
                if (newQ.answers.length === 0) return showSaveError("Vui lòng nhập ít nhất 1 dòng đáp án!");
                if (type === 'single' && correctCount < 1) return showSaveError("Chọn ít nhất 1 đáp án ĐÚNG!");
                if (type === 'multi' && correctCount < 2) return showSaveError("Câu nhiều lựa chọn cần ít nhất 2 đáp án ĐÚNG!");
            }

            if (editingIndex > -1) currentQuizData[editingIndex] = newQ;
            else currentQuizData.push(newQ);

            saveQuizData(); resetForm(); renderQuestionList();

            const errDiv = document.getElementById('save-error-msg');
            errDiv.style.color = 'var(--success)'; errDiv.innerText = "Đã lưu thành công!";
            setTimeout(() => { errDiv.innerText = ""; errDiv.style.color = 'var(--danger)'; }, 2000);
        }

        // --- REORDER LOGIC ---
        function editOrder(currentIdx, spanEl) {
            if (spanEl.querySelector('input')) return;

            const oldVal = currentIdx + 1;
            spanEl.innerHTML = `<input type="number" value="${oldVal}" onblur="confirmOrder(this, ${currentIdx})" onkeydown="if(event.key==='Enter') this.blur()">`;
            spanEl.querySelector('input').focus();
        }

        function confirmOrder(input, oldIdx) {
            let newVal = parseInt(input.value);

            if (isNaN(newVal) || newVal < 1 || newVal > currentQuizData.length) {
                alert("Vui lòng nhập số thứ tự hợp lệ (Số nguyên)!");
                renderQuestionList();
                return;
            }

            let newIdx = newVal - 1;
            if (newIdx === oldIdx) { renderQuestionList(); return; }

            const itemToMove = currentQuizData.splice(oldIdx, 1)[0];
            currentQuizData.splice(newIdx, 0, itemToMove);

            saveQuizData();
            renderQuestionList();
        }

        function renderQuestionList() {
            const list = document.getElementById('questions-list');
            const filter = document.getElementById('q-search').value.toLowerCase();

            list.innerHTML = "";

            let filteredData = currentQuizData.map((q, idx) => ({ ...q, originalIdx: idx }));
            if (filter) {
                filteredData = filteredData.filter(q => q.text.toLowerCase().includes(filter));
            }

            document.getElementById('list-count').innerText = currentQuizData.length;

            filteredData.forEach((q) => {
                const d = document.createElement('div'); d.className = 'q-item';

                const numHtml = filter
                    ? `<span class="q-num">#${q.originalIdx + 1}</span>`
                    : `<span class="q-num" onclick="editOrder(${q.originalIdx}, this)" title="Nhấp để đổi thứ tự">#${q.originalIdx + 1}</span>`;

                d.innerHTML = `
                <div class="q-item-content">
                    ${numHtml}
                    <span class="badge">${q.type}</span>
                    <span>${q.text}</span>
                </div>
                <div class="btn-group">
                    <button class="btn-sm" onclick="editQ(${q.originalIdx})">Sửa</button>
                    <button class="btn-sm" style="color:var(--danger); border-color:rgba(239,68,68,0.3);" onclick="delQ(${q.originalIdx})">Xóa</button>
                </div>
            `;
                list.appendChild(d);
            });
        }

        function delQ(idx) { if (confirm("Xóa câu hỏi này?")) { currentQuizData.splice(idx, 1); saveQuizData(); renderQuestionList(); } }

        function editQ(idx) {
            editingIndex = idx; const q = currentQuizData[idx];
            scrollToTop();
            document.getElementById('form-header').innerText = `Đang sửa câu hỏi #${idx + 1}`;
            document.getElementById('q-type').value = q.type; document.getElementById('q-text').value = q.text; document.getElementById('q-img').value = q.img || "";
            renderOptionsForm(q.type);
            const container = document.getElementById('options-container');

            container.innerHTML = "";
            if (q.type === 'fill') {
                (q.fillAnswers || [q.fillAnswer]).forEach(ans => addFillOptionRow(ans));
            } else if (q.type === 'tf') {
                q.items.forEach(item => addTFOptionRow(item));
            } else if (q.type === 'drag') {
                if (q.groups) {
                    q.groups.forEach(g => addDragGroupRow(g));
                } else if (q.pairs) {
                    q.pairs.forEach(p => addDragGroupRow({ zone: p.target, items: [p.label] }));
                }
            } else {
                q.answers.forEach(a => addNewOptionRow(a));
            }
        }

        function exportJSON() {
            if (currentQuizData.length === 0) return alert("Chưa có dữ liệu!");
            const dataStr = JSON.stringify(currentQuizData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = `bai${currentLessonId}.json`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
        }

        // --- QUIZ ENGINE ---
        let qIdx = 0;

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function shuffleAndRestart() {
            if (currentQuizData.length === 0) return;
            const content = document.getElementById('quiz-content');
            content.classList.add('shuffling');
            setTimeout(() => { shuffleArray(currentQuizData); startQuiz(); }, 300);
            setTimeout(() => { content.classList.remove('shuffling'); }, 600);
        }

        function startQuiz() {
            if (currentQuizData.length === 0) return alert("Bài học này chưa có câu hỏi nào!");
            qIdx = 0;
            document.getElementById('quiz-content').style.display = 'block';
            document.getElementById('review-content').classList.add('hide');
            renderQuizQ();
        }

        // NEW: STUDY MODE
        function enableStudyMode() {
            if (currentQuizData.length === 0) return;
            showReviewScreen();
        }

       function renderQuizQ() {
            const q = currentQuizData[qIdx];
            const area = document.getElementById('quiz-options-area');
            
            // Reset Grid style cho mỗi câu hỏi mới
            area.className = ''; 

            document.getElementById('progress').innerText = `Câu ${qIdx + 1} / ${currentQuizData.length}`;
            
            const qTextEl = document.getElementById('display-q-text');
            if (q.text && q.text.trim() !== "") {
                qTextEl.innerText = q.text;
                qTextEl.style.display = 'block';
            } else {
                qTextEl.style.display = 'none';
            }

            const mi = document.getElementById('display-q-img');
            if (q.img) { mi.src = q.img; mi.style.display = 'inline-block'; } else mi.style.display = 'none';

            document.getElementById('check-btn').classList.add('hide');
            document.getElementById('next-btn').classList.add('hide');
            document.getElementById('quiz-card').classList.remove('shake');
            area.innerHTML = "";

            if (q.type === 'drag') {
                document.getElementById('check-btn').classList.remove('hide');
                const dBox = document.createElement('div'); dBox.className = 'drag-area';
                const zBox = document.createElement('div'); zBox.className = 'drag-area';

                let allItems = [];
                if (q.groups) {
                    q.groups.forEach(g => {
                        g.items.forEach(itm => allItems.push({ label: itm, targetZone: g.zone }));
                    });
                } else if (q.pairs) {
                    q.pairs.forEach(p => allItems.push({ label: p.label, targetZone: p.target }));
                }

                shuffleArray(allItems).forEach((item, i) => {
                    const el = document.createElement('div');
                    el.className = 'draggable'; el.innerText = item.label; el.draggable = true; el.id = `d-${i}`;
                    el.dataset.targetZone = item.targetZone;
                    el.ondragstart = e => e.dataTransfer.setData('sid', e.target.id);
                    dBox.appendChild(el);
                });

                const zones = q.groups ? q.groups.map(g => g.zone) : [...new Set(q.pairs.map(p => p.target))];

                zones.forEach(zName => {
                    const z = document.createElement('div');
                    z.className = 'drop-zone'; z.innerHTML = `<h4>${zName}</h4>`; z.dataset.zoneName = zName;
                    z.ondragover = e => { e.preventDefault(); z.classList.add('hover'); };
                    z.ondragleave = () => z.classList.remove('hover');
                    z.ondrop = e => {
                        e.preventDefault(); z.classList.remove('hover');
                        const el = document.getElementById(e.dataTransfer.getData('sid'));
                        if (el) { el.style.margin = "5px"; z.appendChild(el); }
                    };
                    zBox.appendChild(z);
                });
                area.appendChild(dBox); area.appendChild(zBox);

            } else if (q.type === 'fill') {
                document.getElementById('check-btn').classList.remove('hide');
                const input = document.createElement('input');
                input.type = 'text'; input.className = 'fill-input'; input.id = 'fill-answer-user';
                input.placeholder = 'Nhập câu trả lời...'; input.autocomplete = 'off';
                area.appendChild(input); input.focus();
                input.addEventListener("keypress", function (event) { if (event.key === "Enter") { event.preventDefault(); document.getElementById("check-btn").click(); } });

            } else if (q.type === 'tf') {
                document.getElementById('check-btn').classList.remove('hide');
                q.items.forEach((item, idx) => {
                    const row = document.createElement('div'); row.className = 'tf-row'; row.id = `tf-row-${idx}`;
                    row.innerHTML = `
                    <div class="tf-text">${item.text}</div>
                    <div class="tf-btns">
                        <button class="tf-btn-opt" onclick="selectTF(${idx}, 'true', this)">Đúng</button>
                        <button class="tf-btn-opt" onclick="selectTF(${idx}, 'false', this)">Sai</button>
                    </div>
                `;
                    area.appendChild(row);
                });
            } else {
                if (q.type === 'multi') document.getElementById('check-btn').classList.remove('hide');
                
                // Kích hoạt lưới 2 cột nếu bất kỳ đáp án nào có chứa link ảnh
                if (q.answers.some(a => a.img)) {
                    area.classList.add('grid-mode');
                }

                shuffleArray([...q.answers]).forEach(a => {
                    const btn = document.createElement('div'); btn.className = 'ans-btn';
                    
                    let btnContent = '';
                    if(a.img) btnContent += `<img src="${a.img}" onclick="viewImage(this.src)">`;
                    if(a.text) btnContent += `<span>${a.text}</span>`;
                    btn.innerHTML = btnContent;

                    btn.onclick = (e) => {
                        if (e.target.tagName === 'IMG') return;
                        if (q.type === 'single') {
                            if (a.correct) { btn.classList.add('correct-show'); document.getElementById('next-btn').classList.remove('hide'); }
                            else { btn.classList.add('wrong-show'); setTimeout(() => btn.classList.remove('wrong-show'), 500); }
                        } else { btn.classList.toggle('selected'); btn.dataset.cor = a.correct; }
                    }
                    area.appendChild(btn);
                });
            }
        }

        function selectTF(rowIdx, val, btn) {
            const row = document.getElementById(`tf-row-${rowIdx}`);
            row.querySelectorAll('.tf-btn-opt').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected'); btn.dataset.val = val;
        }

        function checkAnswer() {
            const q = currentQuizData[qIdx];
            let ok = true;

            if (q.type === 'multi') {
                document.querySelectorAll('.ans-btn').forEach(b => {
                    const s = b.classList.contains('selected'); const c = b.dataset.cor === 'true';
                    if (s !== c) ok = false;
                    if (s && c) b.classList.add('correct-show');
                    if (s && !c) b.classList.add('wrong-show');
                });
            } else if (q.type === 'drag') {
                document.querySelectorAll('.drop-zone').forEach(z => {
                    const kids = z.querySelectorAll('.draggable');
                    if (kids.length === 0) ok = false;
                    kids.forEach(k => { if (k.dataset.targetZone !== z.dataset.zoneName) ok = false; });
                    if (ok) z.classList.add('success'); else z.classList.add('error');
                });
                if (document.querySelector('.drag-area:first-child .draggable')) ok = false;

            } else if (q.type === 'fill') {
                const userAns = document.getElementById('fill-answer-user').value.trim().toLowerCase();
                const inputField = document.getElementById('fill-answer-user');
                const answers = q.fillAnswers || [q.fillAnswer];
                const isCorrect = answers.some(ans => ans.toLowerCase() === userAns);
                if (isCorrect) { ok = true; inputField.classList.add('correct'); inputField.readOnly = true; }
                else { ok = false; inputField.classList.add('wrong'); setTimeout(() => inputField.classList.remove('wrong'), 1000); }

            } else if (q.type === 'tf') {
                q.items.forEach((item, idx) => {
                    const row = document.getElementById(`tf-row-${idx}`);
                    const selectedBtn = row.querySelector('.tf-btn-opt.selected');
                    row.classList.remove('tf-correct', 'tf-wrong');
                    if (!selectedBtn) { ok = false; } else {
                        const userVal = selectedBtn.dataset.val === 'true';
                        if (userVal === item.correct) row.classList.add('tf-correct');
                        else { row.classList.add('tf-wrong'); ok = false; }
                    }
                });
            }

            if (ok) {
                document.getElementById('next-btn').classList.remove('hide');
                document.getElementById('check-btn').classList.add('hide');
            } else {
                document.getElementById('quiz-card').classList.add('shake');
                setTimeout(() => { if (q.type !== 'fill' && q.type !== 'tf') renderQuizQ(); }, 1500);
            }
        }

        function nextQuestion() {
            if (qIdx < currentQuizData.length - 1) { qIdx++; renderQuizQ(); }
            else { showSuccessModal(); }
        }

        // --- UPDATED REVIEW LOGIC ---
        function showReviewScreen() {
            document.getElementById('quiz-content').classList.add('hide');
            document.getElementById('review-content').classList.remove('hide');
            document.getElementById('progress').innerText = "Xem lại kết quả";
            const list = document.getElementById('review-list'); list.innerHTML = "";

            currentQuizData.forEach((q, i) => {
                const block = document.createElement('div'); block.className = 'review-q-block';
                let html = `<h3>Câu ${i + 1}: ${q.text}</h3>`;
                if (q.img) html += `<div style="margin-bottom:10px;"><img src="${q.img}" style="max-height:100px; border-radius:5px;" onclick="viewImage(this.src)"></div>`;

                if (q.type === 'drag') {
                    html += `<div style="color:var(--text-muted); font-style:italic;">(Đáp án đúng:)</div>`;
                    if (q.groups) {
                        q.groups.forEach(g => {
                            html += `<div class="review-ans correct-highlight"><strong>${g.zone}:</strong> ${g.items.join(', ')}</div>`;
                        });
                    }
                } else if (q.type === 'fill') {
                    html += `<div class="review-ans correct-highlight">${(q.fillAnswers || [q.fillAnswer]).join(' / ')}</div>`;
                } else if (q.type === 'tf') {
                    q.items.forEach(item => {
                        html += `<div class="review-ans correct-highlight"><span>${item.text}</span> <strong style="margin-left:auto; text-transform:uppercase;">${item.correct ? "Đúng" : "Sai"}</strong></div>`;
                    });
                } else {
                    // Single/Multi: Show ALL options
                    q.answers.forEach(a => {
                        const isCorrect = a.correct;
                        const styleClass = isCorrect ? 'correct-highlight' : 'normal-opt';
                        const icon = isCorrect ? '<i class="fas fa-check-circle" style="margin-left:auto; font-size:1.2em;"></i>' : '';

                        html += `
                        <div class="review-ans ${styleClass}">
                            ${a.img ? `<img src="${a.img}">` : ''}
                            <span>${a.text}</span>
                            ${icon}
                        </div>
                    `;
                    });
                }
                block.innerHTML = html; list.appendChild(block);
            });
        }

        // --- SECURITY ---
        document.addEventListener('keydown', function (e) {
            if (e.keyCode === 123) { e.preventDefault(); return false; }
            if (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74 || e.keyCode === 67)) { e.preventDefault(); return false; }
            if (e.ctrlKey && e.keyCode === 85) { e.preventDefault(); return false; }
        });
        document.addEventListener('contextmenu', function (e) { e.preventDefault(); }, false);
    </script>
</body>
</html>
