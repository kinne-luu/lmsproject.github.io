<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS - Hệ thống trắc nghiệm</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f172a, #1e293b);
            --panel-bg: rgba(30, 41, 59, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --accent: #fbbf24; 
            --danger: #ef4444; 
            --success: #22c55e;
        }

        body {
            margin: 0; font-family: 'Inter', sans-serif;
            background: var(--bg-gradient); 
            background-attachment: fixed;
            color: var(--text-main);
            min-height: 100vh; padding: 20px;
            box-sizing: border-box; 
            transition: all 0.3s ease;
        }

        /* --- LOCK SCREEN (Giao diện nhập Token) --- */
        #lock-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f172a; z-index: 999999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; text-align: center;
        }
        .lock-content {
            background: rgba(30, 41, 59, 0.5); padding: 40px; border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1); max-width: 400px; width: 90%;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        .token-input {
            width: 100%; padding: 15px; margin: 20px 0;
            border-radius: 8px; border: 1px solid var(--accent);
            background: rgba(0,0,0,0.3); color: var(--accent);
            font-size: 1.2em; text-align: center; letter-spacing: 2px;
            outline: none; font-weight: bold;
        }
        .token-input:focus { box-shadow: 0 0 15px rgba(251, 191, 36, 0.3); }
        
        .loader {
            border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--accent);
            border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite;
            margin: 20px auto; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- ADMIN MODE & UI --- */
        body.admin-mode::after {
            content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            z-index: 99999; pointer-events: none;
            box-shadow: inset 0 0 0 4px var(--danger), inset 0 0 30px rgba(239, 68, 68, 0.4);
            animation: pulseRedSoft 2s infinite alternate;
        }
        @keyframes pulseRedSoft { from { box-shadow: inset 0 0 0 4px var(--danger); } to { box-shadow: inset 0 0 0 4px var(--danger), inset 0 0 40px rgba(239, 68, 68, 0.5); } }
        #admin-badge { display: none; position: fixed; top: 0; left: 50%; transform: translateX(-50%); background: var(--danger); color: white; padding: 5px 25px; font-weight: 800; font-size: 0.8em; z-index: 20001; border-radius: 0 0 12px 12px; }
        body.admin-mode #admin-badge { display: block; }
        #admin-toast { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); border: 1px solid var(--accent); color: var(--accent); padding: 15px 40px; border-radius: 50px; display: flex; gap: 15px; z-index: 50003; transition: top 0.4s; }
        #admin-toast.show { top: 80px; }
        .admin-toggle { position: fixed; top: 20px; right: 20px; background: rgba(255,255,255,0.05); color: var(--text-main); border: 1px solid rgba(255,255,255,0.1); cursor: pointer; z-index: 40000; padding: 10px 20px; border-radius: 30px; display: flex; align-items: center; gap: 10px; font-weight: 600; }
        
        /* LAYOUT & COMPONENTS */
        .container { max-width: 900px; margin: 60px auto 50px; }
        .screen { display: none; animation: fadeIn 0.4s ease; } .screen.active { display: block; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .glass-panel { background: var(--panel-bg); backdrop-filter: blur(16px); border: var(--glass-border); border-radius: 20px; padding: 40px; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.05); cursor: pointer; text-align: center; }
        .card:hover { transform: translateY(-5px); background: rgba(255,255,255,0.1); border-color: var(--accent); }
        .card i { font-size: 2em; margin-bottom: 10px; color: var(--accent); }
        
        /* FORM & BUTTONS */
        .form-group { margin-bottom: 20px; } label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--accent); font-size: 0.9em; }
        input[type="text"], textarea, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0, 0, 0, 0.4) !important; color: white !important; box-sizing: border-box; font-family: inherit; }
        input:focus { border-color: var(--accent); outline: none; } select option { background-color: #1e293b; color: white; }
        .btn-primary { background: var(--accent); color: #000; border: none; padding: 12px 30px; font-weight: 700; border-radius: 30px; cursor: pointer; transition: 0.2s; }
        .btn-primary:hover { background: #fff; transform: translateY(-2px); box-shadow: 0 0 15px var(--accent); }
        .btn-danger { background: transparent; color: var(--danger); border: 1px solid var(--danger); padding: 10px 25px; font-weight: 600; border-radius: 30px; cursor: pointer; transition: 0.2s; }
        .btn-danger:hover { background: var(--danger); color: white; }
        .btn-add { width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px dashed rgba(255,255,255,0.3); color: #ccc; cursor: pointer; border-radius: 8px; margin-top: 10px; font-weight: 600; }
        .btn-icon { background: none; border: none; color: rgba(255,255,255,0.4); cursor: pointer; font-size: 1.2em; }
        .btn-icon:hover { color: var(--danger); transform: scale(1.2); }
        
        /* QUIZ UI */
        .opt-row { padding: 10px 0; border-bottom: 1px dashed rgba(255,255,255,0.1); display: flex; align-items: center; gap: 15px; }
        .opt-row input[type="text"] { background: transparent !important; border: none !important; border-bottom: 1px solid rgba(255,255,255,0.3) !important; border-radius: 0 !important; }
        .ans-btn { display: flex; align-items: center; gap: 15px; width: 100%; padding: 18px; margin-bottom: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-main); border-radius: 12px; cursor: pointer; transition: 0.2s; font-weight: 500; }
        .ans-btn:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); }
        .ans-btn.selected { background: rgba(251, 191, 36, 0.2); border-color: var(--accent); color: var(--accent); }
        .ans-btn.correct-show { background: rgba(34, 197, 94, 0.2); border-color: var(--success); color: var(--success); }
        .ans-btn.wrong-show { background: rgba(239, 68, 68, 0.2); border-color: var(--danger); color: var(--danger); }
        .ans-btn img { max-width: 80px; height: auto; border-radius: 5px; border: 1px solid rgba(255,255,255,0.2); margin-right: 10px; order: -1; }
        #display-q-img { max-width: 33.33% !important; height: auto; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.2); display: none; margin: 10px 0; cursor: zoom-in; }
        
        /* FILL & DRAG UI */
        .fill-input { width: 100%; padding: 15px; font-size: 1.1em; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.2); color: white; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        .fill-input.correct { border-color: var(--success); background: rgba(34, 197, 94, 0.1); color: var(--success); }
        .fill-input.wrong { border-color: var(--danger); background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .drag-area { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin: 20px 0; }
        .draggable { background: #1e293b; border: 1px solid var(--accent); color: var(--accent); padding: 10px 20px; border-radius: 8px; cursor: grab; font-weight: 600; }
        .drop-zone { border: 2px dashed rgba(255,255,255,0.2); min-width: 130px; min-height: 90px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; }
        .drop-zone.success { border-color: var(--success); background: rgba(34, 197, 94, 0.1); }
        .drop-zone.error { border-color: var(--danger); background: rgba(239, 68, 68, 0.1); } 

        /* MODALS & MISC */
        .hide { display: none !important; }
        .shake { animation: shakeAnim 0.4s; } @keyframes shakeAnim { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
        #questions-list { margin-top: 15px; max-height: 350px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.05); border-radius: 8px; padding: 5px; }
        .q-item { background: rgba(0,0,0,0.2); padding: 12px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .badge { font-size: 0.7em; padding: 3px 8px; border-radius: 4px; margin-right: 10px; font-weight: 700; background: rgba(255,255,255,0.1); color: var(--accent); border: 1px solid var(--accent); }
        
        #image-viewer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 50000; display: none; justify-content: center; align-items: center; }
        #image-viewer.active { display: flex; }
        #full-image { max-width: 90vw; max-height: 90vh; object-fit: contain; }
        .close-viewer { position: absolute; top: 20px; right: 20px; color: white; font-size: 2em; cursor: pointer; background: none; border: none; }
        
        #success-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 60000; display: none; align-items: center; justify-content: center; }
        #success-modal.active { display: flex; }
        .modal-content { background: #1e293b; padding: 30px; border-radius: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.1); max-width: 350px; width: 90%; }
    </style>
</head>
<body>

    <div id="lock-screen">
        <div class="lock-content">
            <div id="lock-icon" style="font-size: 3em; color: var(--danger); margin-bottom: 20px;">
                <i class="fas fa-lock"></i>
            </div>
            <h2 style="color: var(--danger); margin-bottom: 10px;">YÊU CẦU QUYỀN TRUY CẬP</h2>
            <p id="lock-msg">Vui lòng nhập mã kích hoạt để tiếp tục:</p>
            
            <input type="text" id="token-input" class="token-input" placeholder="MÃ TOKEN" autocomplete="off">
            
            <div id="lock-loader" class="loader"></div>
            
            <button class="btn-primary" onclick="verifyToken()" style="width: 100%;">
                <i class="fas fa-unlock-alt"></i> Kích hoạt ngay
            </button>
            
            <p id="error-msg" style="color: var(--danger); margin-top: 15px; font-weight: bold; display: none;"></p>
        </div>
    </div>

    <div id="image-viewer">
        <button class="close-viewer" onclick="document.getElementById('image-viewer').classList.remove('active')"><i class="fas fa-times"></i></button>
        <img id="full-image" src="">
    </div>

    <div id="success-modal">
        <div class="modal-content">
            <h3 style="color: var(--success); margin-bottom: 10px;">Hoàn thành!</h3>
            <p style="color: var(--text-muted); margin-bottom: 25px;">Bạn đã trả lời hết các câu hỏi.</p>
            <button class="btn-primary" onclick="closeSuccessModal()">Xem kết quả</button>
        </div>
    </div>

    <div id="admin-badge">Endmin Mode</div>
    <div id="admin-toast">
        <i class="fas fa-check-circle" style="color: var(--success);"></i>
        <span>Welcome back, Endministrator</span>
    </div>

    <button class="admin-toggle" onclick="toggleAdmin()">
        <i class="fas fa-user-shield"></i>
        <span>Endministrator</span>
    </button>

    <div class="container">
        <section id="home-screen" class="screen active">
            <div class="glass-panel" style="text-align: center;">
                <h1 style="color: var(--accent); font-size: 2em; margin-bottom: 10px;">HỆ THỐNG TRẮC NGHIỆM</h1>
                <p style="color: var(--text-muted); margin-bottom: 30px;">Chọn môn học để bắt đầu ôn tập</p>
                <div class="grid" id="subjects-grid"></div>
            </div>
        </section>

        <section id="lesson-screen" class="screen">
            <div class="glass-panel">
                <button onclick="goHome()" style="background:none; border:none; color:var(--text-muted); cursor:pointer; margin-bottom:20px; font-weight: 600;">
                    <i class="fas fa-arrow-left"></i> Quay lại trang chủ
                </button>
                <h2 id="current-subject-title" style="color: var(--accent);">Tên Môn</h2>
                <p id="admin-hint" class="hide" style="color:var(--danger); font-weight:600; background: rgba(239, 68, 68, 0.1); display: inline-block; padding: 5px 15px; border-radius: 20px; border: 1px solid var(--danger);">[Đang ở chế độ chỉnh sửa]</p>
                <div class="grid" id="lessons-grid"></div>
            </div>
        </section>

        <section id="quiz-screen" class="screen">
            <div class="glass-panel" id="quiz-card">
                <div style="display:flex; justify-content:space-between; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <span id="progress" style="font-weight: 700; color: var(--accent);">Câu 1</span>
                    <span onclick="goBackToLessons()" style="cursor:pointer; color: var(--text-muted); font-size: 0.9em;">Thoát bài tập</span>
                </div>
                <div id="loading">Đang tải dữ liệu...</div>
                <div id="quiz-content">
                    <h3 id="display-q-text" style="margin: 20px 0; font-weight: 600; font-size: 1.3em;"></h3>
                    <div style="text-align:left; margin-bottom:20px;">
                        <img id="display-q-img" src="" onclick="viewImage(this.src)" alt="Question Image">
                    </div>
                    <div id="quiz-options-area"></div>
                    <div style="margin-top: 30px; text-align: right;">
                        <button id="check-btn" class="btn-primary hide" onclick="checkAnswer()">Kiểm tra đáp án</button>
                        <button id="next-btn" class="btn-primary hide" onclick="nextQuestion()">Câu tiếp theo <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
                <div id="review-content" class="hide">
                    <h2 style="color: var(--success); text-align: center; margin-bottom: 30px;">Xem lại đáp án</h2>
                    <div id="review-list"></div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn-primary" onclick="goBackToLessons()">Hoàn thành & Thoát</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="admin-editor-screen" class="screen">
            <div class="glass-panel">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px;">
                    <h3 id="editor-title" style="margin:0; color: var(--accent);">Trình chỉnh sửa</h3>
                    <button onclick="goBackToLessons()" class="btn-danger">Đóng</button>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 25px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.05);">
                    <h4 id="form-header" style="margin-top:0; color:var(--text-main);">Thêm câu hỏi mới</h4>
                    <div class="form-group">
                        <label>Loại câu hỏi</label>
                        <select id="q-type" onchange="renderOptionsForm()">
                            <option value="single">Chọn 1 đáp án (Single)</option>
                            <option value="multi">Chọn nhiều đáp án (Multi)</option>
                            <option value="drag">Kéo thả (Drag & Drop)</option>
                            <option value="fill">Điền từ (Fill in blank)</option>
                        </select>
                        <p id="drag-hint" style="color:var(--accent); font-size:0.85em; margin-top:5px; font-style:italic; display:none;">*Chú ý: Đặt tên "Ô đáp án" giống nhau để kéo nhiều đáp án vào chung 1 ô.</p>
                    </div>
                    <div class="form-group">
                        <label>Nội dung câu hỏi</label>
                        <textarea id="q-text" rows="2" placeholder="Ví dụ: Thủ đô của Việt Nam là ..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Hình ảnh (Tùy chọn)</label>
                        <div style="display:flex; align-items:center;">
                            <input type="text" id="q-img" placeholder="Dán link ảnh vào đây..." oninput="previewImage(this, 'editor-prev')">
                            <img id="editor-prev" class="preview-img" src="" style="display:none;">
                        </div>
                    </div>
                    <div id="options-container" style="margin-top:20px;"></div>
                    <button id="add-opt-btn" class="btn-add" onclick="addNewOptionRow()">+ Thêm dòng đáp án</button>
                    <div style="margin-top:30px; text-align:right; gap: 10px; display: flex; justify-content: flex-end;">
                        <button class="btn-danger" style="border:1px solid rgba(255,255,255,0.2); color: #ccc;" onclick="resetForm()">Làm mới</button>
                        <button class="btn-primary" onclick="saveQuestion()">Lưu câu hỏi</button>
                    </div>
                </div>
                <h4 style="margin-top: 40px; color: var(--text-muted); display:flex; justify-content:flex-start; align-items:center;">Danh sách câu hỏi (<span id="list-count">0</span>)</h4>
                <div id="questions-list"></div>
                <div style="margin-top:30px; text-align:center;">
                    <button class="btn-primary" style="background: transparent; border: 1px solid var(--success); color: var(--success);" onclick="exportJSON()"><i class="fas fa-download"></i> Tải file dữ liệu (.JSON) về máy</button>
                </div>
            </div>
        </section>
    </div>

<script>
    // --- 1. CONFIG & TOKEN AUTHENTICATION ---
    // [QUAN TRỌNG] Thay link này bằng link Web App bạn copy từ bước Deploy
    const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbzQeBgm6l9nwv-ympcTAx5LULBuLX1vixjcknckDyhZbzdMcPrTPGzFVluw2qTFsO9eBw/exec"; 
    
    let remoteAdminPass = ""; 

    async function checkSavedToken() {
        const savedToken = localStorage.getItem('lms_token');
        if (savedToken) {
            document.getElementById('token-input').value = savedToken;
            verifyToken(savedToken);
        }
    }

    async function verifyToken(val = null) {
        const token = val || document.getElementById('token-input').value.trim();
        const errorMsg = document.getElementById('error-msg');
        const loader = document.getElementById('lock-loader');
        
        if (!token) {
            errorMsg.innerText = "Vui lòng nhập mã!";
            errorMsg.style.display = 'block';
            return;
        }

        // UI Processing
        errorMsg.style.display = 'none';
        loader.style.display = 'block';
        document.getElementById('lock-msg').innerText = "Đang kiểm tra mã...";

        try {
            const response = await fetch(`${GOOGLE_SHEET_URL}?token=${token}`);
            const data = await response.json();

            if (data.status === "Access Granted") {
                // Success
                localStorage.setItem('lms_token', token);
                remoteAdminPass = data.adminPass;
                document.getElementById('lock-screen').style.display = 'none';
                console.log("Access Granted with Token: " + token);
            } else {
                // Fail
                errorMsg.innerText = "Mã không đúng hoặc chưa được cấp quyền!";
                errorMsg.style.display = 'block';
                localStorage.removeItem('lms_token');
            }
        } catch (e) {
            console.error(e);
            errorMsg.innerText = "Lỗi kết nối máy chủ!";
            errorMsg.style.display = 'block';
        } finally {
            loader.style.display = 'none';
            document.getElementById('lock-msg').innerText = "Vui lòng nhập mã kích hoạt để tiếp tục:";
        }
    }

    // Auto check on load
    checkSavedToken();

    // --- 2. LOGIC ỨNG DỤNG ---
    const subjects = [
        { id: 'kinhte', name: 'Kinh tế chính trị Mác - Lê Nin', icon: 'fa-book', lessons: 6 },
        { id: 'laptrinhC', name: 'Lập trình C Nâng cao', icon: 'fa-code', lessons: 9 },
        { id: 'thongtinso', name: 'Thông tin Số', icon: 'fa-network-wired', lessons: 9 },
        { id: 'truyensolieu', name: 'Kỹ thuật truyền số liệu', icon: 'fa-satellite-dish', lessons: 9 },
        { id: 'maydien', name: 'Máy điện', icon: 'fa-bolt', lessons: 9 }
    ];

    let currentSubjectId = null;
    let currentLessonId = null;
    let isAdminMode = false;
    let currentQuizData = [];
    let editingIndex = -1;

    // ZOOM VARS
    let imgScale = 1; let imgTranslateX = 0; let imgTranslateY = 0;
    let isDraggingImg = false; let startDragX, startDragY;

    function init() {
        const grid = document.getElementById('subjects-grid');
        grid.innerHTML = "";
        subjects.forEach(sub => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<i class="fas ${sub.icon}"></i><h3>${sub.name}</h3>`;
            card.onclick = () => openLessons(sub);
            grid.appendChild(card);
        });
        document.getElementById('image-viewer').addEventListener('wheel', handleZoom, { passive: false });
        window.addEventListener('mousemove', dragImage);
        window.addEventListener('mouseup', stopDragImage);
    }
    init();

    // --- IMAGE VIEWER ---
    function viewImage(src) {
        if(window.event) window.event.stopPropagation();
        const viewer = document.getElementById('image-viewer');
        const img = document.getElementById('full-image');
        img.src = src; imgScale = 1; imgTranslateX = 0; imgTranslateY = 0;
        updateImageTransform(); viewer.classList.add('active');
    }
    function handleZoom(e) {
        e.preventDefault(); const zoomStep = 0.1;
        if (e.deltaY < 0) imgScale += zoomStep; else imgScale -= zoomStep;
        imgScale = Math.min(Math.max(0.5, imgScale), 5); updateImageTransform();
    }
    function startDrag(e) {
        if(e.target.id !== 'full-image' && e.target.id !== 'viewer-container') return;
        isDraggingImg = true; startDragX = e.clientX - imgTranslateX; startDragY = e.clientY - imgTranslateY;
        document.getElementById('viewer-container').style.cursor = 'grabbing';
    }
    function dragImage(e) {
        if (!isDraggingImg) return; e.preventDefault();
        imgTranslateX = e.clientX - startDragX; imgTranslateY = e.clientY - startDragY;
        updateImageTransform();
    }
    function stopDragImage() { isDraggingImg = false; document.getElementById('viewer-container').style.cursor = 'grab'; }
    function updateImageTransform() { document.getElementById('full-image').style.transform = `translate(${imgTranslateX}px, ${imgTranslateY}px) scale(${imgScale})`; }

    // --- NAVIGATION & MODALS ---
    function showSuccessModal() { document.getElementById('success-modal').classList.add('active'); }
    function closeSuccessModal() { document.getElementById('success-modal').classList.remove('active'); showReviewScreen(); }
    
    function showReviewScreen() {
        document.getElementById('quiz-content').classList.add('hide');
        document.getElementById('review-content').classList.remove('hide');
        document.getElementById('progress').innerText = "Xem lại kết quả";
        const list = document.getElementById('review-list'); list.innerHTML = "";

        currentQuizData.forEach((q, i) => {
            const block = document.createElement('div'); block.className = 'review-q-block';
            let html = `<h3>Câu ${i+1}: ${q.text}</h3>`;
            if(q.img) html += `<div style="margin-bottom:10px;"><img src="${q.img}" style="max-height:100px; border-radius:5px;" onclick="viewImage(this.src)"></div>`;
            
            if(q.type === 'drag') {
                html += `<div style="color:var(--text-muted); font-style:italic;">(Câu hỏi kéo thả - Đáp án đúng:)</div>`;
                q.pairs.forEach(p => html += `<div class="review-ans correct">${p.label} <i class="fas fa-arrow-right"></i> ${p.target}</div>`);
            } else if (q.type === 'fill') {
                html += `<div style="color:var(--text-muted); margin-bottom:5px;">Các đáp án được chấp nhận:</div>`;
                const answers = q.fillAnswers || [q.fillAnswer];
                html += `<div class="review-ans correct">${answers.join(' / ')}</div>`;
            } else {
                q.answers.forEach(a => {
                    const isCorrect = a.correct ? 'correct' : '';
                    const icon = a.correct ? '<i class="fas fa-check" style="margin-left:auto;"></i>' : '';
                    html += `<div class="review-ans ${isCorrect}">
                        ${a.img ? `<img src="${a.img}" onclick="viewImage(this.src)">` : ''}
                        <span>${a.text || '(Hình ảnh)'}</span> ${icon}
                    </div>`;
                });
            }
            block.innerHTML = html; list.appendChild(block);
        });
    }

    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function goHome() { currentSubjectId = null; showScreen('home-screen'); }
    function goBackToLessons() { if(currentSubjectId) openLessons(subjects.find(s => s.id === currentSubjectId)); else goHome(); }

    // --- ADMIN LOGIC (SECURE) ---
    function toggleAdmin() {
        if(isAdminMode) {
            isAdminMode = false; document.body.classList.remove('admin-mode');
            showToast("Endmin log out"); goHome();
        } else {
            // Kiểm tra mật khẩu lấy từ Google Sheet
            const inputPass = prompt("Nhập mật khẩu Admin:");
            if(remoteAdminPass && inputPass === remoteAdminPass) {
                isAdminMode = true; document.body.classList.add('admin-mode');
                showToast("Welcome back, Endministrator"); goHome(); 
            } else {
                alert("Sai mật khẩu hoặc chưa được cấp quyền Admin!");
            }
        }
    }
    function showToast(msg) {
        const toast = document.getElementById('admin-toast');
        toast.querySelector('span').innerText = msg;
        toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 1000);
    }

    function openLessons(subject) {
        currentSubjectId = subject.id;
        document.getElementById('current-subject-title').innerText = subject.name;
        document.getElementById('admin-hint').classList.toggle('hide', !isAdminMode);
        const grid = document.getElementById('lessons-grid'); grid.innerHTML = "";
        for(let i=1; i<=subject.lessons; i++) {
            const card = document.createElement('div'); card.className = 'card';
            card.innerHTML = `<h3 style="margin-top:5px;">Bài ${i}</h3>`;
            card.onclick = () => { currentLessonId = i; smartLoadData(currentSubjectId, i); };
            grid.appendChild(card);
        }
        showScreen('lesson-screen');
    }

    async function smartLoadData(subId, lesId) {
        currentQuizData = []; 
        if (isAdminMode) {
            const localKey = `quiz_${subId}_${lesId}`; const raw = localStorage.getItem(localKey);
            currentQuizData = raw ? JSON.parse(raw) : []; openAdminEditor();
        } else {
            const jsonPath = `data/${subId}/bai${lesId}.json`;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('quiz-content').style.display = 'none';
            document.getElementById('review-content').classList.add('hide'); 
            showScreen('quiz-screen');
            try {
                const response = await fetch(jsonPath); if (!response.ok) throw new Error("File not found");
                currentQuizData = await response.json(); startQuiz();
            } catch (error) {
                const localKey = `quiz_${subId}_${lesId}`; const raw = localStorage.getItem(localKey);
                if(raw) { currentQuizData = JSON.parse(raw); startQuiz(); }
                else { alert("Bài học này chưa có dữ liệu!"); goBackToLessons(); }
            } finally { document.getElementById('loading').style.display = 'none'; }
        }
    }

    // --- EDITOR & QUIZ LOGIC (Standard) ---
    function saveQuizData() { localStorage.setItem(`quiz_${currentSubjectId}_${currentLessonId}`, JSON.stringify(currentQuizData)); }
    function openAdminEditor() {
        showScreen('admin-editor-screen'); document.getElementById('editor-title').innerText = `Chỉnh sửa: ${currentSubjectId} / Bài ${currentLessonId}`;
        resetForm(); renderQuestionList();
    }
    function resetForm() {
        editingIndex = -1; document.getElementById('form-header').innerText = "Thêm câu hỏi mới";
        document.getElementById('q-text').value = ""; document.getElementById('q-img').value = "";
        document.getElementById('editor-prev').style.display = 'none'; renderOptionsForm();
    }
    function previewImage(input, imgId) { const img = document.getElementById(imgId); if(input.value) { img.src = input.value; img.style.display = "block"; } else { img.style.display = "none"; } }

    function renderOptionsForm(presetType=null) {
        const type = presetType || document.getElementById('q-type').value;
        const container = document.getElementById('options-container');
        const hint = document.getElementById('drag-hint');
        const addBtn = document.getElementById('add-opt-btn');
        container.innerHTML = ""; addBtn.style.display = 'block';
        if(type === 'fill') {
            hint.style.display = 'none'; addBtn.onclick = () => addFillOptionRow();
            if(editingIndex === -1) addFillOptionRow();
        } else {
            addBtn.onclick = () => addNewOptionRow();
            hint.style.display = type === 'drag' ? 'block' : 'none';
            if(editingIndex === -1) { addNewOptionRow(); addNewOptionRow(); }
        }
    }
    function addFillOptionRow(value = '') {
        const container = document.getElementById('options-container');
        const div = document.createElement('div'); div.className = 'opt-row';
        div.innerHTML = `<label style="width: auto; margin:0; color:var(--success); white-space:nowrap; margin-right:10px;">Đáp án:</label><input type="text" class="fill-option-text" value="${value}" placeholder="Nhập một đáp án chấp nhận..." style="flex:1"><button class="btn-icon" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>`;
        container.appendChild(div);
    }
    function addNewOptionRow(data=null) {
        const type = document.getElementById('q-type').value;
        const container = document.getElementById('options-container');
        const div = document.createElement('div'); div.className = 'opt-row';
        if(type === 'drag') {
            const l = data?data.label:''; const t = data?data.target:'';
            div.innerHTML = `<input type="text" class="drag-source" value="${l}" placeholder="Đáp án (VD: R1)" style="flex:1"><i class="fas fa-arrow-right" style="color:var(--accent)"></i><input type="text" class="drag-target" value="${t}" placeholder="Ô đáp án (VD: Nhóm A)" style="flex:1"><button class="btn-icon" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>`;
        } else {
            const itype = type==='single'?'radio':'checkbox';
            const chk = data?(data.correct?'checked':''):''; const txt = data?data.text:''; const img = data?(data.img||''):'';
            div.innerHTML = `<input type="${itype}" name="cor" class="correct-chk" ${chk} style="transform:scale(1.5); cursor:pointer; accent-color: var(--accent);"><div style="flex:1; display:flex; gap:10px;"><input type="text" class="opt-text" value="${txt}" placeholder="Nội dung đáp án..."><input type="text" class="opt-img" value="${img}" placeholder="Link ảnh..."></div><button class="btn-icon" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>`;
        }
        container.appendChild(div);
    }
    function saveQuestion() {
        const type = document.getElementById('q-type').value;
        const text = document.getElementById('q-text').value;
        const img = document.getElementById('q-img').value;
        if(!text) return alert("Vui lòng nhập nội dung câu hỏi!");
        let newQ = { type, text, img: img||null };
        if (type === 'fill') {
            newQ.fillAnswers = []; document.querySelectorAll('.fill-option-text').forEach(inp => { if(inp.value.trim()) newQ.fillAnswers.push(inp.value.trim()); });
            if(newQ.fillAnswers.length === 0) return alert("Cần ít nhất 1 đáp án đúng!");
        } else if(type === 'drag') {
            newQ.pairs = []; document.querySelectorAll('.opt-row').forEach(r => { const s = r.querySelector('.drag-source').value; const t = r.querySelector('.drag-target').value; if(s && t) newQ.pairs.push({ label:s, target:t }); });
            if(newQ.pairs.length < 1) return alert("Vui lòng nhập ít nhất 1 cặp kéo thả!");
        } else {
            newQ.answers = []; document.querySelectorAll('.opt-row').forEach(r => { const txt = r.querySelector('.opt-text').value; const i = r.querySelector('.opt-img').value; const c = r.querySelector('.correct-chk').checked; if(txt || i) newQ.answers.push({ text:txt, img:i||null, correct:c }); });
        }
        if(editingIndex > -1) currentQuizData[editingIndex] = newQ; else currentQuizData.push(newQ);
        saveQuizData(); resetForm(); renderQuestionList();
    }
    function renderQuestionList() {
        const list = document.getElementById('questions-list');
        document.getElementById('list-count').innerText = currentQuizData.length; list.innerHTML = "";
        currentQuizData.forEach((q, idx) => {
            const d = document.createElement('div'); d.className = 'q-item';
            d.innerHTML = `<div class="q-item-content"><span class="badge">${q.type}</span><span>${q.text}</span></div><div class="btn-group"><button class="btn-sm" onclick="editQ(${idx})">Sửa</button><button class="btn-sm" style="color:var(--danger); border-color:rgba(239,68,68,0.3);" onclick="delQ(${idx})">Xóa</button></div>`;
            list.appendChild(d);
        });
    }
    function delQ(idx) { if(confirm("Xóa câu hỏi này?")) { currentQuizData.splice(idx,1); saveQuizData(); renderQuestionList(); } }
    function editQ(idx) {
        editingIndex = idx; const q = currentQuizData[idx];
        document.getElementById('form-header').innerText = `Đang sửa câu hỏi #${idx+1}`;
        document.getElementById('q-type').value = q.type; document.getElementById('q-text').value = q.text; document.getElementById('q-img').value = q.img||"";
        renderOptionsForm(q.type);
        const container = document.getElementById('options-container'); container.innerHTML = "";
        if (q.type === 'fill') { (q.fillAnswers || (q.fillAnswer ? [q.fillAnswer] : [])).forEach(ans => addFillOptionRow(ans)); } 
        else { if(q.type === 'drag') q.pairs.forEach(p => addNewOptionRow(p)); else q.answers.forEach(a => addNewOptionRow(a)); }
    }
    function exportJSON() {
        if(currentQuizData.length === 0) return alert("Chưa có dữ liệu!");
        const dataStr = JSON.stringify(currentQuizData, null, 2); const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = `bai${currentLessonId}.json`;
        document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
    }

    let qIdx = 0;
    function startQuiz() { if(currentQuizData.length === 0) return alert("Bài học này chưa có câu hỏi nào!"); qIdx = 0; document.getElementById('quiz-content').style.display = 'block'; renderQuizQ(); }
    function renderQuizQ() {
        const q = currentQuizData[qIdx]; const area = document.getElementById('quiz-options-area');
        document.getElementById('progress').innerText = `Câu ${qIdx+1} / ${currentQuizData.length}`;
        document.getElementById('display-q-text').innerText = q.text;
        const mi = document.getElementById('display-q-img'); if(q.img) { mi.src=q.img; mi.style.display='inline-block'; } else mi.style.display='none';
        document.getElementById('check-btn').classList.add('hide'); document.getElementById('next-btn').classList.add('hide'); document.getElementById('quiz-card').classList.remove('shake');
        area.innerHTML = "";
        if(q.type === 'drag') {
            document.getElementById('check-btn').classList.remove('hide');
            const dBox = document.createElement('div'); dBox.className='drag-area'; const zBox = document.createElement('div'); zBox.className='drag-area';
            q.pairs.forEach((p,i) => { const item = document.createElement('div'); item.className='draggable'; item.innerText=p.label; item.draggable=true; item.id=`d-${i}`; item.dataset.target = p.target; item.ondragstart = e => e.dataTransfer.setData('sid', e.target.id); dBox.appendChild(item); });
            [...new Set(q.pairs.map(p=>p.target))].forEach(t => { const z = document.createElement('div'); z.className='drop-zone'; z.innerHTML=`<h4>${t}</h4>`; z.dataset.match=t; z.ondragover = e => { e.preventDefault(); z.classList.add('hover'); }; z.ondragleave = () => z.classList.remove('hover'); z.ondrop = e => { e.preventDefault(); z.classList.remove('hover'); const el = document.getElementById(e.dataTransfer.getData('sid')); el.style.margin="2px"; z.appendChild(el); }; zBox.appendChild(z); });
            area.appendChild(dBox); area.appendChild(zBox);
        } else if (q.type === 'fill') {
            document.getElementById('check-btn').classList.remove('hide');
            const input = document.createElement('input'); input.type = 'text'; input.className = 'fill-input'; input.id = 'fill-answer-user'; input.placeholder = 'Nhập câu trả lời của bạn vào đây...'; input.autocomplete = 'off'; area.appendChild(input); input.focus();
            input.addEventListener("keypress", function(event) { if (event.key === "Enter") { event.preventDefault(); document.getElementById("check-btn").click(); } });
        } else {
            if(q.type === 'multi') document.getElementById('check-btn').classList.remove('hide');
            q.answers.forEach(a => { const btn = document.createElement('div'); btn.className='ans-btn'; btn.innerHTML = `${a.img ? `<img src="${a.img}" onclick="viewImage(this.src)">` : ''}<span>${a.text}</span>`; btn.onclick = (e) => { if(e.target.tagName === 'IMG') return; if(q.type === 'single') { if(a.correct) { btn.classList.add('correct-show'); document.getElementById('next-btn').classList.remove('hide'); } else { btn.classList.add('wrong-show'); setTimeout(()=>btn.classList.remove('wrong-show'),500); } } else { btn.classList.toggle('selected'); btn.dataset.cor = a.correct; } }; area.appendChild(btn); });
        }
    }
    function checkAnswer() {
        const q = currentQuizData[qIdx]; let ok = true;
        if(q.type === 'multi') { document.querySelectorAll('.ans-btn').forEach(b => { const s = b.classList.contains('selected'); const c = b.dataset.cor === 'true'; if(s !== c) ok = false; if(s && c) b.classList.add('correct-show'); if(s && !c) b.classList.add('wrong-show'); }); }
        else if (q.type === 'drag') { document.querySelectorAll('.drop-zone').forEach(z => { const kids = z.querySelectorAll('.draggable'); if(kids.length === 0) ok = false; kids.forEach(k => { if(k.dataset.target !== z.dataset.match) ok = false; }); if(ok) z.classList.add('success'); else z.classList.add('error'); }); if(document.querySelector('.drag-area:first-child .draggable')) ok = false; }
        else if (q.type === 'fill') { const userAns = document.getElementById('fill-answer-user').value.trim().toLowerCase(); const inputField = document.getElementById('fill-answer-user'); const isCorrect = (q.fillAnswers || [q.fillAnswer]).some(ans => ans.toLowerCase() === userAns); if (isCorrect) { ok = true; inputField.classList.add('correct'); inputField.readOnly = true; } else { ok = false; inputField.classList.add('wrong'); setTimeout(() => inputField.classList.remove('wrong'), 1000); } }
        if(ok) { document.getElementById('next-btn').classList.remove('hide'); document.getElementById('check-btn').classList.add('hide'); } else { document.getElementById('quiz-card').classList.add('shake'); setTimeout(() => { if(q.type !== 'fill') renderQuizQ(); }, 1500); }
    }
    function nextQuestion() { if(qIdx < currentQuizData.length - 1) { qIdx++; renderQuizQ(); } else { showSuccessModal(); } }

    // ANTI-DEBUG
    document.addEventListener('keydown', function(e) { if (e.keyCode === 123) { e.preventDefault(); return false; } if (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74 || e.keyCode === 67)) { e.preventDefault(); return false; } if (e.ctrlKey && e.keyCode === 85) { e.preventDefault(); return false; } });
    document.addEventListener('contextmenu', function(e) { e.preventDefault(); }, false);
</script>
</body>
</html>
